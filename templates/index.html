<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-music"></i>
            RockSound
        </div>
        <ul class="menu">
            <li class="menu-item active" data-target="view-dashboard">
                <i class="fa-solid fa-house"></i>
                Trang ch·ªß
            </li>
            <li class="menu-item" data-target="view-isolation">
                <i class="fa-solid fa-guitar"></i>
                T√°ch nh·∫°c c·ª•
            </li>
            <li class="menu-item" data-target="view-stems">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                Ph√≤ng thu hi·ªáu ·ª©ng
            </li>
            <li class="menu-item" data-target="view-voice">
                <i class="fa-solid fa-wave-square"></i>
                Ph√¢n t√≠ch chuy√™n s√¢u
            </li>
        </ul>
    </div>

    <div class="main-content">
        <!-- Global Session Bar -->
        <div id="session-bar" class="session-bar" style="display:none;">
            <div class="session-info">
                <i class="fa-solid fa-file-audio"></i>
                <span id="active-filename">Ch∆∞a ch·ªçn t·ªáp</span>
            </div>
            <button class="btn-reset" onclick="resetSession()">
                <i class="fa-solid fa-rotate-left"></i> ƒê·∫∑t l·∫°i & Ch·ªçn t·ªáp m·ªõi
            </button>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-section active">
            <header>
                <h1>Ch√†o m·ª´ng ƒë·∫øn v·ªõi RockSound</h1>
                <p class="subtitle">Ph√≤ng thu x·ª≠ l√Ω √¢m thanh chuy√™n nghi·ªáp d√†nh cho b·∫°n</p>
            </header>

            <div id="main-upload-area" class="upload-area">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <h3>B·∫Øt ƒë·∫ßu t·∫°i ƒë√¢y: T·∫£i l√™n b·∫£n nh·∫°c c·ªßa b·∫°n</h3>
                <p>H·ªó tr·ª£ ƒë·ªãnh d·∫°ng MP3, WAV, FLAC</p>
                <input type="file" id="file-main" hidden accept="audio/*">
            </div>

            <div class="card-grid" id="dashboard-features" style="display:none;">
                <div class="card" onclick="switchView('view-spectrogram')">
                    <div class="card-icon"><i class="fa-solid fa-microscope"></i></div>
                    <h3>Ph√¢n t√≠ch ph·ªï</h3>
                    <p style="font-size:0.8rem; color:#888;">Xem chi ti·∫øt t·∫ßn s·ªë</p>
                </div>
                <div class="card" onclick="switchView('view-isolation')">
                    <div class="card-icon"><i class="fa-solid fa-guitar"></i></div>
                    <h3>T√°ch nh·∫°c c·ª•</h3>
                    <p style="font-size:0.8rem; color:#888;">T√°ch tr·ªëng, bass, vocal...</p>
                </div>
                <div class="card" onclick="switchView('view-stems')">
                    <div class="card-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <h3>Hi·ªáu ·ª©ng</h3>
                    <p style="font-size:0.8rem; color:#888;">Ch·ªânh s·ª≠a & Mix nh·∫°c</p>
                </div>
            </div>
        </div>



        <!-- Isolation View -->
        <div id="view-isolation" class="view-section">
            <header>
                <h1>T√°ch c√°c th√†nh ph·∫ßn b·∫£n nh·∫°c</h1>
                <p class="subtitle">S·ª≠ d·ª•ng thu·∫≠t to√°n AI ƒë·ªÉ t√°ch Guitar, Tr·ªëng, Bass v√† L·ªùi h√°t</p>
            </header>
            <div id="isolation-placeholder" class="empty-state">
                <i class="fa-solid fa-guitar"></i>
                <h3>S·∫µn s√†ng t√°ch nh·∫°c c·ª•</h3>
                <button class="btn-primary" id="btn-run-isolation">B·∫Øt ƒë·∫ßu t√°ch ngay</button>
            </div>
            <div id="result-isolation" class="analysis-results" style="display:none;">
                <div class="stems-container"></div>
            </div>
        </div>

        <!-- Stems Mixing View -->
        <div id="view-stems" class="view-section">
            <header>
                <h1>Ph√≤ng thu hi·ªáu ·ª©ng</h1>
                <p class="subtitle">√Åp d·ª•ng hi·ªáu ·ª©ng chuy√™n nghi·ªáp cho b·∫£n thu c·ªßa b·∫°n</p>
            </header>

            <div id="studio-mode-selector" class="studio-toggle-container" style="display:none;">
                <button class="toggle-btn active" id="btn-mode-stems">Nh·∫°c c·ª• ƒë√£ t√°ch</button>
                <button class="toggle-btn" id="btn-mode-single">B·∫£n g·ªëc</button>
            </div>

            <div id="mixer-placeholder" class="empty-state">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <h3>Hi·ªáu ·ª©ng & Tr·ªôn nh·∫°c (Mixing)</h3>
                <p>Ch·ªçn ch·∫ø ƒë·ªô l√†m vi·ªác ph√≠a tr√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                <div style="display:flex; gap:1rem; margin-top:1rem;">
                    <button class="btn-primary" onclick="setStudioMode('single')">X·ª≠ l√Ω b·∫£n g·ªëc</button>
                    <button class="btn-secondary" onclick="switchView('view-isolation')">ƒêi ƒë·∫øn T√°ch nh·∫°c c·ª•
                        tr∆∞·ªõc</button>
                </div>
            </div>

            <div id="effects-editor" style="display:none;">
                <div class="mixer-tracks" id="editor-track"></div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-process-single">√Åp d·ª•ng & Xu·∫•t t·ªáp</button>
                    <div id="single-result" style="display:none; margin-top: 1rem;"><audio controls id="single-preview"
                            style="width:100%"></audio></div>
                </div>
            </div>

            <div id="mixer-container" style="display:none;">
                <div class="mixer-tracks" id="mixer-tracks"></div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-render-mix">Xu·∫•t b·∫£n Mix th√†nh ph·∫©m</button>
                    <div id="render-result" style="display:none; margin-top: 1rem;"><audio controls id="master-preview"
                            style="width:100%"></audio></div>
                </div>
            </div>
        </div>

        <!-- Advanced Analysis View -->
        <div id="view-voice" class="view-section">
            <header>
                <h1>Ph√¢n t√≠ch chuy√™n s√¢u</h1>
                <p class="subtitle">√Åp d·ª•ng c√°c k·ªπ thu·∫≠t x·ª≠ l√Ω t√≠n hi·ªáu √¢m thanh ti√™n ti·∫øn</p>
            </header>

            <div id="voice-placeholder" class="empty-state">
                <i class="fa-solid fa-wave-square"></i>
                <h3>Ready for Advanced Analysis</h3>
                <p>√Åp d·ª•ng c√°c k·ªπ thu·∫≠t LPC, Formant, Pitch Tracking</p>
            </div>

            <div id="voice-analysis-container" style="display:none;">
                <!-- Analysis Buttons -->
                <div class="voice-controls"
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:1.5rem; margin-bottom:2rem;">

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-lpc-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-chart-line"></i> Ph√¢n t√≠ch LPC
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">M√¥ ph·ªèng ngu·ªìn √¢m thanh v√† b·ªô l·ªçc c·ªông h∆∞·ªüng
                            c·ªßa nh·∫°c c·ª•.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-waveform-analysis"
                            style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-water"></i> D·∫°ng s√≥ng (Waveform)
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">H√¨nh ·∫£nh tr·ª±c quan v·ªÅ bi√™n ƒë·ªô √¢m thanh theo
                            th·ªùi gian.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-formant-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-mountain"></i> B·ªìi √¢m (Harmonics)
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">X√°c ƒë·ªãnh c√°c ƒë·ªânh t·∫ßn s·ªë t·∫°o n√™n m√†u s·∫Øc ƒë·∫∑c
                            tr∆∞ng c·ªßa √¢m thanh.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-pitch-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-music"></i> Theo d√µi cao ƒë·ªô
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">D√≤ t√¨m n·ªët nh·∫°c v√† s·ª± thay ƒë·ªïi t·∫ßn s·ªë ch√≠nh
                            x√°c theo th·ªùi gian.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-detailed-spec" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-image"></i> Ph·ªï chi ti·∫øt
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">Bi·ªÉu ƒë·ªì FFT ƒë·ªô ph√¢n gi·∫£i cao cho c√°i nh√¨n
                            s√¢u s·∫Øc nh·∫•t.</p>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="voice-results">
                    <!-- LPC Results -->
                    <div id="lpc-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-chart-line"></i> Linear Predictive Coding Analysis</h3>
                        <div class="lpc-content"></div>
                    </div>

                    <!-- Waveform Results -->
                    <div id="waveform-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-water"></i> Waveform Visualization</h3>
                        <canvas id="waveform-canvas" width="800" height="300"
                            style="width:100%; border:1px solid #333; border-radius:8px;"></canvas>
                        <div class="waveform-info" style="margin-top:1rem;"></div>
                    </div>

                    <!-- Formant Results -->
                    <div id="formant-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-mountain"></i> Formant Analysis</h3>
                        <div class="formant-content"></div>
                    </div>

                    <!-- Pitch Results -->
                    <div id="pitch-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-music"></i> Pitch Tracking</h3>
                        <canvas id="pitch-canvas" width="800" height="300"
                            style="width:100%; border:1px solid #333; border-radius:8px;"></canvas>
                        <div class="pitch-info" style="margin-top:1rem;"></div>
                    </div>

                    <!-- Detailed Spectrogram Results -->
                    <div id="detailed-spec-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-image"></i> Detailed Spectrogram (FFT-based)</h3>
                        <div class="spec-content"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global Session State
        let session = {
            filename: "",
            analysis: null,
            stems: null,
            studioMode: "stems" // 'stems' or 'single'
        };

        // Navigation Logic
        const menuItems = document.querySelectorAll('.menu-item');
        const sections = document.querySelectorAll('.view-section');

        function switchView(targetId) {
            sections.forEach(sec => {
                sec.classList.remove('active');
                if (sec.id === targetId) sec.classList.add('active');
            });
            menuItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.target === targetId) item.classList.add('active');
            });
            updateSessionUI(); // Sync UI whenever switching tabs
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const target = item.dataset.target;
                if (target) switchView(target);
            });
        });

        // Initialize Upload
        const mainUploadArea = document.getElementById('main-upload-area');
        const fileMain = document.getElementById('file-main');

        mainUploadArea.addEventListener('click', () => fileMain.click());

        fileMain.onchange = async (e) => {
            if (!e.target.files.length) return;
            const file = e.target.files[0];

            // 1. Show Loading on Dashboard
            mainUploadArea.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i><h3>Uploading ${file.name}...</h3>`;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Upload failed");

                session.filename = data.filename;
                updateSessionUI();
            } catch (err) {
                alert(err.message);
                resetSession();
            }
        };

        function updateSessionUI() {
            const hasFile = !!session.filename;
            document.getElementById('session-bar').style.display = hasFile ? 'flex' : 'none';
            document.getElementById('active-filename').textContent = session.filename || "No file selected";

            // Dashboard UI
            document.getElementById('main-upload-area').style.display = hasFile ? 'none' : 'flex';
            document.getElementById('dashboard-features').style.display = hasFile ? 'grid' : 'none';

            // Feature view placeholders (simple version)
            document.getElementById('analysis-placeholder').style.display = (hasFile && !session.analysis) ? 'flex' : 'none';
            document.getElementById('result-spectrogram').style.display = session.analysis ? 'block' : 'none';
            if (session.analysis) renderAnalysis(session.analysis);

            document.getElementById('isolation-placeholder').style.display = (hasFile && !session.stems) ? 'flex' : 'none';
            document.getElementById('result-isolation').style.display = session.stems ? 'block' : 'none';
            if (session.stems) renderStems(session.stems);

            // Studio UI
            const modeSelector = document.getElementById('studio-mode-selector');
            modeSelector.style.display = hasFile ? 'flex' : 'none';

            const hasStems = !!session.stems;
            const mode = session.studioMode;

            // Toggle Buttons
            document.getElementById('btn-mode-stems').classList.toggle('active', mode === 'stems');
            document.getElementById('btn-mode-single').classList.toggle('active', mode === 'single');

            // Workspace visibility
            const pleader = document.getElementById('mixer-placeholder');
            const meditor = document.getElementById('effects-editor');
            const mcontainer = document.getElementById('mixer-container');

            pleader.style.display = 'none';
            meditor.style.display = 'none';
            mcontainer.style.display = 'none';

            if (mode === 'stems') {
                if (hasStems) {
                    mcontainer.style.display = 'block';
                    setupMixer(session.stems);
                } else {
                    pleader.style.display = 'flex';
                    pleader.querySelector('p').textContent = "Please isolate instruments first to use multi-track mixer.";
                }
            } else { // mode === 'single'
                meditor.style.display = 'block';
                const container = document.getElementById('editor-track');
                if (container.children.length === 0) {
                    createTrackStrip("Original Track", container);
                }
            }
        }

        function setStudioMode(mode) {
            session.studioMode = mode;
            updateSessionUI();
        }

        document.getElementById('btn-mode-stems').onclick = () => setStudioMode('stems');
        document.getElementById('btn-mode-single').onclick = () => setStudioMode('single');

        function resetSession() {
            session = { filename: "", analysis: null, stems: null };
            document.getElementById('file-main').value = '';
            // Reset Dashboard icons
            mainUploadArea.innerHTML = `<i class="fa-solid fa-cloud-arrow-up"></i><h3>Start here: Upload your track</h3><p>Supports MP3, WAV, FLAC</p>`;

            // Clear result containers
            document.getElementById('result-spectrogram').querySelector('.analysis-content').innerHTML = '';
            document.getElementById('result-isolation').querySelector('.stems-container').innerHTML = '';
            document.getElementById('mixer-tracks').innerHTML = '';
            document.getElementById('editor-track').innerHTML = '';

            updateSessionUI();
            switchView('view-dashboard');
        }

        // Feature Actions
        document.getElementById('btn-run-analysis').onclick = async () => {
            const btn = document.getElementById('btn-run-analysis');
            const resContainer = document.getElementById('result-spectrogram');
            const status = resContainer.querySelector('.status-text');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            resContainer.style.display = 'block';

            try {
                const res = await fetch('/analyze/spectrogram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();
                session.analysis = data;
                renderAnalysis(data);
                updateSessionUI();
            } catch (err) {
                status.textContent = "Error: " + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "Start Analysis";
            }
        };

        document.getElementById('btn-run-isolation').onclick = async () => {
            const btn = document.getElementById('btn-run-isolation');
            const resContainer = document.getElementById('result-isolation');
            const status = resContainer.querySelector('.status-text');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            resContainer.style.display = 'block';

            try {
                const res = await fetch('/analyze/isolation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();
                session.stems = data.stems;
                renderStems(data.stems);
                updateSessionUI();
            } catch (err) {
                status.textContent = "Error: " + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "Separate Instruments";
            }
        };

        function renderAnalysis(data) {
            const container = document.getElementById('result-spectrogram').querySelector('.analysis-content');
            container.innerHTML = `
                <div class="analysis-grid">
                    <div class="stat-card"><span class="label">BPM</span><span class="value">${data.bpm}</span></div>
                    <div class="stat-card"><span class="label">Key</span><span class="value">${data.key}</span></div>
                    <div class="stat-card"><span class="label">Duration</span><span class="value">${data.duration}s</span></div>
                    <div class="stat-card"><span class="label">Sample Rate</span><span class="value">${data.sample_rate}Hz</span></div>
                </div>
                <div><h3>Spectrogram</h3><img src="${data.spectrogram_url}" class="analysis-img"></div>
                <div style="margin-top:2rem"><h3>Waveform</h3><img src="${data.waveform_url}" class="analysis-img"></div>
            `;
        }

        function renderStems(stems) {
            const container = document.getElementById('result-isolation').querySelector('.stems-container');
            container.innerHTML = '';
            Object.entries(stems).forEach(([label, url]) => {
                const row = document.createElement('div');
                row.className = 'stem-player';
                row.innerHTML = `<div class="stem-name">${label}</div><audio controls src="${url}"></audio>`;
                container.appendChild(row);
            });
        }

        // Mixer Logic
        function setupMixer(stems) {
            const container = document.getElementById('mixer-tracks');
            const existingStems = Array.from(container.querySelectorAll('.track-strip')).map(s => s.dataset.label);
            const newStems = Object.keys(stems);

            // Only rebuild if the labels changed
            if (JSON.stringify(existingStems) === JSON.stringify(newStems)) return;

            container.innerHTML = '';
            newStems.forEach(label => {
                createTrackStrip(label, container);
            });
        }

        function createTrackStrip(label, container) {
            const strip = document.createElement('div');
            strip.className = 'track-strip';
            strip.dataset.label = label;
            strip.innerHTML = `
                <div class="track-name">${label}</div>
                
                <div class="control-group">
                    <div class="control-label"><span>Vol</span> <span class="val">1.0</span></div>
                    <input type="range" class="control-slider vol-slider" min="0" max="2" step="0.1" value="1.0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Speed</span> <span class="val">1.0</span>x</div>
                    <input type="range" class="control-slider speed-slider" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Pitch</span> <span class="val">0</span> st</div>
                    <input type="range" class="control-slider pitch-slider" min="-12" max="12" step="1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Distort</span> <span class="val">0</span>%</div>
                    <input type="range" class="control-slider dist-slider" min="0" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Echo</span> <span class="val">0</span>%</div>
                    <input type="range" class="control-slider echo-slider" min="0" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>LPF</span> <span class="val">20k</span>Hz</div>
                    <input type="range" class="control-slider lpf-slider" min="100" max="20000" step="100" value="20000">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>HPF</span> <span class="val">20</span>Hz</div>
                    <input type="range" class="control-slider hpf-slider" min="20" max="5000" step="50" value="20">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Reverb</span> <span class="val">0</span></div>
                    <input type="range" class="control-slider reverb-slider" min="0" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Pan</span> <span class="val">0</span></div>
                    <input type="range" class="control-slider pan-slider" min="-1" max="1" step="0.1" value="0">
                </div>
            `;

            strip.querySelectorAll('input').forEach(input => {
                input.oninput = (e) => {
                    let val = e.target.value;
                    if (val >= 1000) val = (val / 1000).toFixed(1) + 'k';
                    e.target.previousElementSibling.querySelector('.val').textContent = val;
                };
            });

            container.appendChild(strip);
        }

        function getTrackData(strip, url) {
            return {
                url: url,
                volume: parseFloat(strip.querySelector('.vol-slider').value),
                speed: parseFloat(strip.querySelector('.speed-slider').value),
                pitch: parseFloat(strip.querySelector('.pitch-slider').value),
                distortion: parseFloat(strip.querySelector('.dist-slider').value),
                echo: parseFloat(strip.querySelector('.echo-slider').value),
                lpf: parseFloat(strip.querySelector('.lpf-slider').value),
                hpf: parseFloat(strip.querySelector('.hpf-slider').value),
                reverb: parseFloat(strip.querySelector('.reverb-slider').value),
                pan: parseFloat(strip.querySelector('.pan-slider').value)
            };
        }

        document.getElementById('btn-render-mix').onclick = async () => {
            const btn = document.getElementById('btn-render-mix');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            const tracks = [];
            document.querySelectorAll('#mixer-tracks .track-strip').forEach(strip => {
                const label = strip.dataset.label;
                tracks.push(getTrackData(strip, session.stems[label]));
            });

            try {
                const res = await fetch('/process/mix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tracks })
                });
                const data = await res.json();
                const preview = document.getElementById('master-preview');
                preview.src = data.mix_url;
                document.getElementById('render-result').style.display = 'block';
                preview.play();
            } catch (err) { alert(err.message); }
            finally {
                btn.disabled = false;
                btn.textContent = "Render Mix";
            }
        };


        document.getElementById('btn-process-single').onclick = async () => {
            const btn = document.getElementById('btn-process-single');
            btn.disabled = true;
            btn.textContent = "Processing...";

            const strip = document.getElementById('editor-track').querySelector('.track-strip');
            const track = getTrackData(strip, "/uploads/" + session.filename);

            try {
                const res = await fetch('/process/mix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tracks: [track] })
                });
                const data = await res.json();
                const preview = document.getElementById('single-preview');
                preview.src = data.mix_url;
                document.getElementById('single-result').style.display = 'block';
                preview.play();
            } catch (err) { alert(err.message); }
            finally {
                btn.disabled = false;
                btn.textContent = "Apply & Export";
            }
        };

        // Voice Analysis Functions
        function updateVoiceUI() {
            const hasFile = !!session.filename;
            document.getElementById('voice-placeholder').style.display = hasFile ? 'none' : 'flex';
            document.getElementById('voice-analysis-container').style.display = hasFile ? 'block' : 'none';
        }

        // Update session UI to include voice analysis
        const originalUpdateSessionUI = updateSessionUI;
        updateSessionUI = function () {
            originalUpdateSessionUI();
            updateVoiceUI();
        };

        // LPC Analysis
        document.getElementById('btn-lpc-analysis').onclick = async () => {
            const btn = document.getElementById('btn-lpc-analysis');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            try {
                const res = await fetch('/analyze/lpc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();

                // Check for errors
                if (data.error || !res.ok) {
                    throw new Error(data.error || 'LPC analysis failed');
                }

                const container = document.getElementById('lpc-results');
                const content = container.querySelector('.lpc-content');

                content.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(33, 150, 243, 0.1)); padding:1rem; border-radius:8px; margin-bottom:1.5rem;">
                        <h4 style="margin:0; color:#4CAF50;">‚úÖ ${data.lpc_data.analysis_type === 'Musical Instrument (optimized)' ? 'Ph√¢n t√≠ch Nh·∫°c c·ª• (ƒê√£ t·ªëi ∆∞u)' : 'Ho√†n t·∫•t'}</h4>
                        <p style="margin:0.5rem 0 0 0; color:#999; font-size:0.9rem;">
                            T·∫ßn s·ªë l·∫•y m·∫´u: ${data.lpc_data.sample_rate}Hz | Khung: ${data.lpc_data.frame_length} samples | B·∫≠c: ${data.lpc_data.order}
                        </p>
                    </div>
                    <div style="display:grid; gap:2rem;">
                        <div>
                            <h4>H·ªá s·ªë LPC (B·∫≠c ${data.lpc_data.order})</h4>
                            <p style="color:#999; font-size:0.85rem; margin-bottom:0.5rem;">
                                üé∏ T·ªëi ∆∞u cho nh·∫°c c·ª•: B·∫≠c cao gi√∫p b·∫Øt ƒë∆∞·ª£c c√°c b·ªìi √¢m ph·ª©c t·∫°p.
                            </p>
                            <div style="background:#1a1a1a; padding:1rem; border-radius:8px; overflow-x:auto; max-height:300px;">
                                <code style="color:#4CAF50; font-size:0.9rem;">
                                    ${data.lpc_data.lpc_coefficients.map((c, i) => `a[${i}] = ${c.toFixed(6)}`).join('<br>')}
                                </code>
                            </div>
                        </div>
                        <div>
                            <h4>H·ªá s·ªë Cepstral</h4>
                            <p style="color:#999; font-size:0.85rem; margin-bottom:0.5rem;">
                                üéµ ƒê·∫∑c t√≠nh √¢m s·∫Øc - d√πng ƒë·ªÉ nh·∫≠n d·∫°ng lo·∫°i nh·∫°c c·ª•.
                            </p>
                            <div style="background:#1a1a1a; padding:1rem; border-radius:8px; overflow-x:auto; max-height:300px;">
                                <code style="color:#2196F3; font-size:0.9rem;">
                                    ${data.lpc_data.cepstral_coefficients.slice(0, 20).map((c, i) => `c[${i}] = ${c.toFixed(6)}`).join('<br>')}
                                </code>
                            </div>
                        </div>
                        <div>
                            <h4>Bi·ªÉu ƒë·ªì T·ª± t∆∞∆°ng quan (Autocorrelation)</h4>
                            <img src="${data.autocorrelation_plot}" class="analysis-img" style="width:100%; border-radius:8px;">
                        </div>
                    </div>
                `;

                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                alert('LPC Analysis Error: ' + err.message);
                console.error('LPC Error:', err);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-chart-line"></i> LPC Analysis';
            }
        };

        // Waveform Analysis
        document.getElementById('btn-waveform-analysis').onclick = async () => {
            const btn = document.getElementById('btn-waveform-analysis');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            try {
                const res = await fetch('/analyze/waveform', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();

                // Draw waveform on canvas
                const canvas = document.getElementById('waveform-canvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Background
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Center line
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, canvas.height / 2);
                ctx.lineTo(canvas.width, canvas.height / 2);
                ctx.stroke();

                // Draw waveform
                ctx.strokeStyle = '#FF9800';
                ctx.lineWidth = 2;
                ctx.beginPath();

                const points = data.waveform.points;
                const scaleX = canvas.width / 600;
                const scaleY = canvas.height / 300;

                points.forEach((point, i) => {
                    const x = point.x * scaleX;
                    const y = canvas.height / 2 - point.y * scaleY;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                    const y = displayCanvas.height / 2 - point.y * scaleY;
                    if (i === 0) displayCtx.moveTo(x, y);
                    else displayCtx.lineTo(x, y);
                });
                displayCtx.stroke();

                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                alert('Waveform Error: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-water"></i> Waveform';
            }
        };

        // Formant Analysis
        document.getElementById('btn-formant-analysis').onclick = async () => {
            const btn = document.getElementById('btn-formant-analysis');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            try {
                const res = await fetch('/analyze/formants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();

                const container = document.getElementById('formant-results');
                const content = container.querySelector('.formant-content');

                content.innerHTML = `
                    <div style="background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 193, 7, 0.1)); padding:1rem; border-radius:8px; margin-bottom:1.5rem;">
                        <h4 style="margin:0; color:#FF9800;">üéµ Ph√¢n t√≠ch B·ªìi √¢m (T·ªëi ∆∞u Nh·∫°c c·ª•)</h4>
                        <p style="margin:0.5rem 0 0 0; color:#999; font-size:0.9rem;">
                            Ph√°t hi·ªán ${data.formants.length} ƒë·ªânh ph·ªï. ƒê·ªëi v·ªõi nh·∫°c c·ª•, ƒë√¢y l√† b·ªìi √¢m (harmonics).
                        </p>
                    </div>
                    <div style="display:grid; gap:1rem;">
                        ${data.formants.map((f, i) => {
                    const isHarmonic = f.type === 'harmonic';
                    return `
                            <div class="stat-card" style="background: linear-gradient(135deg, #1a1a1a, #2a2a2a);">
                                <span class="label">${isHarmonic ? 'üé∏ B·ªìi √¢m' : 'ƒê·ªânh'} ${i + 1}</span>
                                <span class="value">${f.frequency.toFixed(2)} Hz</span>
                                <span style="color:#999; font-size:0.9rem;">C∆∞·ªùng ƒë·ªô: ${f.magnitude.toFixed(2)}</span>
                            </div>
                        `}).join('')}
                    </div>
                    <div style="margin-top:1.5rem; padding:1rem; background:rgba(33, 150, 243, 0.1); border-radius:8px;">
                        <p style="margin:0; color:#999; font-size:0.85rem;">
                            üí° <strong>Ghi ch√∫:</strong> Nh·∫°c c·ª• c√≥ 8 b·ªìi √¢m (so v·ªõi 4 formant ·ªü ti·∫øng n√≥i). 
                            K√≠ch th∆∞·ªõc FFT: 4096 cho ƒë·ªô ph√¢n gi·∫£i t·∫ßn s·ªë t·ªët h∆°n.
                        </p>
                    </div>
                `;

                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                alert('Formant Analysis Error: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-mountain"></i> Formants';
            }
        };

        // Pitch Tracking
        document.getElementById('btn-pitch-analysis').onclick = async () => {
            const btn = document.getElementById('btn-pitch-analysis');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            try {
                const res = await fetch('/analyze/pitch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();

                const container = document.getElementById('pitch-results');
                const content = container.querySelector('.pitch-content'); // Assuming a .pitch-content element exists within #pitch-results

                // Set the HTML content, including the canvas element
                content.innerHTML = `
                    <div class="pitch-meta" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:1rem; margin-bottom:1rem;">
                        <div class="stat-card"><span class="label">ƒêi·ªÉm d·ªØ li·ªáu</span><span class="value">${data.pitch_data.length}</span></div>
                        ${data.pitch_data.length > 0 ? `
                            <div class="stat-card"><span class="label">N·ªët ƒë·∫ßu ti√™n</span><span class="value">${data.pitch_data[0].note}</span></div>
                            <div class="stat-card"><span class="label">T·∫ßn s·ªë ƒë·∫ßu ti√™n</span><span class="value">${data.pitch_data[0].frequency.toFixed(2)}Hz</span></div>
                        ` : ''}
                    </div>
                    <canvas id="pitch-canvas-display" width="600" height="300" style="width:100%; height:300px; background:#0a0a0a; border-radius:8px;"></canvas>
                `;

                // Now get the newly created canvas and draw on it
                const displayCanvas = document.getElementById('pitch-canvas-display');
                const displayCtx = displayCanvas.getContext('2d');

                // Background
                displayCtx.fillStyle = '#0a0a0a';
                displayCtx.fillRect(0, 0, displayCanvas.width, displayCanvas.height);

                if (data.pitch_data && data.pitch_data.length > 0) {
                    // Find min/max frequency
                    const freqs = data.pitch_data.map(p => p.frequency);
                    const minFreq = Math.min(...freqs);
                    const maxFreq = Math.max(...freqs);
                    const freqRange = maxFreq - minFreq;

                    // Draw pitch curve
                    displayCtx.strokeStyle = '#4CAF50';
                    displayCtx.lineWidth = 3;
                    displayCtx.beginPath();

                    data.pitch_data.forEach((point, i) => {
                        const x = (i / data.pitch_data.length) * displayCanvas.width;
                        const y = displayCanvas.height - ((point.frequency - minFreq) / freqRange) * (displayCanvas.height - 40) - 20;
                        if (i === 0) displayCtx.moveTo(x, y);
                        else displayCtx.lineTo(x, y);
                    });
                    displayCtx.stroke();

                    // Draw points
                    displayCtx.fillStyle = '#4CAF50';
                    data.pitch_data.forEach((point, i) => {
                        const x = (i / data.pitch_data.length) * displayCanvas.width;
                        const y = displayCanvas.height - ((point.frequency - minFreq) / freqRange) * (displayCanvas.height - 40) - 20;
                        displayCtx.beginPath();
                        displayCtx.arc(x, y, 3, 0, Math.PI * 2);
                        displayCtx.fill();
                    });
                }

                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                alert('Pitch Tracking Error: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-music"></i> Pitch Tracking';
            }
        };

        // Detailed Spectrogram
        document.getElementById('btn-detailed-spec').onclick = async () => {
            const btn = document.getElementById('btn-detailed-spec');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            try {
                const res = await fetch('/analyze/detailed_spectrogram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();

                const container = document.getElementById('detailed-spec-results');
                const content = container.querySelector('.spec-content');

                content.innerHTML = `
                    <h4 style="margin-bottom:1rem; color:#03A9F4;">üñºÔ∏è Bi·ªÉu ƒë·ªì Ph·ªï chi ti·∫øt (FFT 512)</h4>
                    <img src="${data.spectrogram_url}" class="analysis-img" style="width:100%; border-radius:8px;">
                    <p style="margin-top:1rem; color:#888; font-size:0.85rem;">
                        Bi·ªÉu ƒë·ªì n√†y hi·ªÉn th·ªã c∆∞·ªùng ƒë·ªô √¢m thanh qua c√°c khung th·ªùi gian v√† d·∫£i t·∫ßn s·ªë bin.
                    </p>
                `;

                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } catch (err) {
                alert('Detailed Spectrogram Error: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-image"></i> Detailed Spectrogram';
            }
        };

    </script>
</body>