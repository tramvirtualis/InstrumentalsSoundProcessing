<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-music"></i>
            RockSound
        </div>
        <ul class="menu">
            <li class="menu-item active" data-target="view-dashboard">
                <i class="fa-solid fa-house"></i>
                Dashboard
            </li>
            <li class="menu-item" data-target="view-noise">
                <i class="fa-solid fa-sliders"></i>
                Noise Reduction
            </li>
            <li class="menu-item" data-target="view-isolation">
                <i class="fa-solid fa-guitar"></i>
                Instrument Isolation
            </li>
            <li class="menu-item" data-target="view-spectrogram">
                <i class="fa-solid fa-microscope"></i>
                Audio Analysis
            </li>
            <li class="menu-item" data-target="view-stems">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                Effects Studio
            </li>
            <li class="menu-item">
                <i class="fa-solid fa-gear"></i>
                Settings
            </li>
        </ul>
    </div>

    <div class="main-content">
        <!-- Global Session Bar -->
        <div id="session-bar" class="session-bar" style="display:none;">
            <div class="session-info">
                <i class="fa-solid fa-file-audio"></i>
                <span id="active-filename">No file selected</span>
            </div>
            <button class="btn-reset" onclick="resetSession()">
                <i class="fa-solid fa-rotate-left"></i> Reset & New File
            </button>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-section active">
            <header>
                <h1>Welcome to RockSound</h1>
                <p class="subtitle">Complete pro-audio processing studio</p>
            </header>

            <div id="main-upload-area" class="upload-area">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <h3>Start here: Upload your track</h3>
                <p>Supports MP3, WAV, FLAC</p>
                <input type="file" id="file-main" hidden accept="audio/*">
            </div>

            <div class="card-grid" id="dashboard-features" style="display:none;">
                <div class="card" onclick="switchView('view-spectrogram')">
                    <div class="card-icon"><i class="fa-solid fa-microscope"></i></div>
                    <h3>Analyze</h3>
                </div>
                <div class="card" onclick="switchView('view-isolation')">
                    <div class="card-icon"><i class="fa-solid fa-guitar"></i></div>
                    <h3>Isolate</h3>
                </div>
                <div class="card" onclick="switchView('view-stems')">
                    <div class="card-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <h3>Edit Effects</h3>
                </div>
            </div>
        </div>

        <!-- Audio Analysis View -->
        <div id="view-spectrogram" class="view-section">
            <header>
                <h1>Audio Analysis</h1>
                <p class="subtitle">Extract technical insights</p>
            </header>
            <div id="analysis-placeholder" class="empty-state">
                <i class="fa-solid fa-microscope"></i>
                <h3>Ready to Analyze</h3>
                <button class="btn-primary" id="btn-run-analysis">Start Analysis</button>
            </div>
            <div id="result-spectrogram" class="analysis-results" style="display:none;">
                <div class="analysis-content"></div>
            </div>
        </div>

        <!-- Isolation View -->
        <div id="view-isolation" class="view-section">
            <header>
                <h1>Instrument Isolation</h1>
            </header>
            <div id="isolation-placeholder" class="empty-state">
                <i class="fa-solid fa-guitar"></i>
                <h3>Ready to Isolate Stems</h3>
                <button class="btn-primary" id="btn-run-isolation">Separate Instruments</button>
            </div>
            <div id="result-isolation" class="analysis-results" style="display:none;">
                <div class="stems-container"></div>
            </div>
        </div>

        <!-- Stems Mixing View -->
        <div id="view-stems" class="view-section">
            <header>
                <h1>Effects Studio</h1>
            </header>

            <div id="studio-mode-selector" class="studio-toggle-container" style="display:none;">
                <button class="toggle-btn active" id="btn-mode-stems">Isolated Stems</button>
                <button class="toggle-btn" id="btn-mode-single">Original File</button>
            </div>

            <div id="mixer-placeholder" class="empty-state">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <h3>Effects & Mixing</h3>
                <p>Choose your workspace mode above</p>
                <div style="display:flex; gap:1rem; margin-top:1rem;">
                    <button class="btn-primary" onclick="setStudioMode('single')">Process Original Track</button>
                    <button class="btn-secondary" onclick="switchView('view-isolation')">Go to Isolation First</button>
                </div>
            </div>

            <div id="effects-editor" style="display:none;">
                <div class="mixer-tracks" id="editor-track"></div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-process-single">Apply & Export</button>
                    <div id="single-result" style="display:none; margin-top: 1rem;"><audio controls id="single-preview"
                            style="width:100%"></audio></div>
                </div>
            </div>

            <div id="mixer-container" style="display:none;">
                <div class="mixer-tracks" id="mixer-tracks"></div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-render-mix">Render Mix</button>
                    <div id="render-result" style="display:none; margin-top: 1rem;"><audio controls id="master-preview"
                            style="width:100%"></audio></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global Session State
        let session = {
            filename: "",
            analysis: null,
            stems: null,
            studioMode: "stems" // 'stems' or 'single'
        };

        // Navigation Logic
        const menuItems = document.querySelectorAll('.menu-item');
        const sections = document.querySelectorAll('.view-section');

        function switchView(targetId) {
            sections.forEach(sec => {
                sec.classList.remove('active');
                if (sec.id === targetId) sec.classList.add('active');
            });
            menuItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.target === targetId) item.classList.add('active');
            });
            updateSessionUI(); // Sync UI whenever switching tabs
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const target = item.dataset.target;
                if (target) switchView(target);
            });
        });

        // Initialize Upload
        const mainUploadArea = document.getElementById('main-upload-area');
        const fileMain = document.getElementById('file-main');

        mainUploadArea.addEventListener('click', () => fileMain.click());

        fileMain.onchange = async (e) => {
            if (!e.target.files.length) return;
            const file = e.target.files[0];

            // 1. Show Loading on Dashboard
            mainUploadArea.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i><h3>Uploading ${file.name}...</h3>`;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Upload failed");

                session.filename = data.filename;
                updateSessionUI();
            } catch (err) {
                alert(err.message);
                resetSession();
            }
        };

        function updateSessionUI() {
            const hasFile = !!session.filename;
            document.getElementById('session-bar').style.display = hasFile ? 'flex' : 'none';
            document.getElementById('active-filename').textContent = session.filename || "No file selected";

            // Dashboard UI
            document.getElementById('main-upload-area').style.display = hasFile ? 'none' : 'flex';
            document.getElementById('dashboard-features').style.display = hasFile ? 'grid' : 'none';

            // Feature view placeholders (simple version)
            document.getElementById('analysis-placeholder').style.display = (hasFile && !session.analysis) ? 'flex' : 'none';
            document.getElementById('result-spectrogram').style.display = session.analysis ? 'block' : 'none';
            if (session.analysis) renderAnalysis(session.analysis);

            document.getElementById('isolation-placeholder').style.display = (hasFile && !session.stems) ? 'flex' : 'none';
            document.getElementById('result-isolation').style.display = session.stems ? 'block' : 'none';
            if (session.stems) renderStems(session.stems);

            // Studio UI
            const modeSelector = document.getElementById('studio-mode-selector');
            modeSelector.style.display = hasFile ? 'flex' : 'none';

            const hasStems = !!session.stems;
            const mode = session.studioMode;

            // Toggle Buttons
            document.getElementById('btn-mode-stems').classList.toggle('active', mode === 'stems');
            document.getElementById('btn-mode-single').classList.toggle('active', mode === 'single');

            // Workspace visibility
            const pleader = document.getElementById('mixer-placeholder');
            const meditor = document.getElementById('effects-editor');
            const mcontainer = document.getElementById('mixer-container');

            pleader.style.display = 'none';
            meditor.style.display = 'none';
            mcontainer.style.display = 'none';

            if (mode === 'stems') {
                if (hasStems) {
                    mcontainer.style.display = 'block';
                    setupMixer(session.stems);
                } else {
                    pleader.style.display = 'flex';
                    pleader.querySelector('p').textContent = "Please isolate instruments first to use multi-track mixer.";
                }
            } else { // mode === 'single'
                meditor.style.display = 'block';
                const container = document.getElementById('editor-track');
                if (container.children.length === 0) {
                    createTrackStrip("Original Track", container);
                }
            }
        }

        function setStudioMode(mode) {
            session.studioMode = mode;
            updateSessionUI();
        }

        document.getElementById('btn-mode-stems').onclick = () => setStudioMode('stems');
        document.getElementById('btn-mode-single').onclick = () => setStudioMode('single');

        function resetSession() {
            session = { filename: "", analysis: null, stems: null };
            document.getElementById('file-main').value = '';
            // Reset Dashboard icons
            mainUploadArea.innerHTML = `<i class="fa-solid fa-cloud-arrow-up"></i><h3>Start here: Upload your track</h3><p>Supports MP3, WAV, FLAC</p>`;

            // Clear result containers
            document.getElementById('result-spectrogram').querySelector('.analysis-content').innerHTML = '';
            document.getElementById('result-isolation').querySelector('.stems-container').innerHTML = '';
            document.getElementById('mixer-tracks').innerHTML = '';
            document.getElementById('editor-track').innerHTML = '';

            updateSessionUI();
            switchView('view-dashboard');
        }

        // Feature Actions
        document.getElementById('btn-run-analysis').onclick = async () => {
            const btn = document.getElementById('btn-run-analysis');
            const resContainer = document.getElementById('result-spectrogram');
            const status = resContainer.querySelector('.status-text');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            resContainer.style.display = 'block';

            try {
                const res = await fetch('/analyze/spectrogram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();
                session.analysis = data;
                renderAnalysis(data);
                updateSessionUI();
            } catch (err) {
                status.textContent = "Error: " + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "Start Analysis";
            }
        };

        document.getElementById('btn-run-isolation').onclick = async () => {
            const btn = document.getElementById('btn-run-isolation');
            const resContainer = document.getElementById('result-isolation');
            const status = resContainer.querySelector('.status-text');

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
            resContainer.style.display = 'block';

            try {
                const res = await fetch('/analyze/isolation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: session.filename })
                });
                const data = await res.json();
                session.stems = data.stems;
                renderStems(data.stems);
                updateSessionUI();
            } catch (err) {
                status.textContent = "Error: " + err.message;
            } finally {
                btn.disabled = false;
                btn.textContent = "Separate Instruments";
            }
        };

        function renderAnalysis(data) {
            const container = document.getElementById('result-spectrogram').querySelector('.analysis-content');
            container.innerHTML = `
                <div class="analysis-grid">
                    <div class="stat-card"><span class="label">BPM</span><span class="value">${data.bpm}</span></div>
                    <div class="stat-card"><span class="label">Key</span><span class="value">${data.key}</span></div>
                    <div class="stat-card"><span class="label">Duration</span><span class="value">${data.duration}s</span></div>
                    <div class="stat-card"><span class="label">Sample Rate</span><span class="value">${data.sample_rate}Hz</span></div>
                </div>
                <div><h3>Spectrogram</h3><img src="${data.spectrogram_url}" class="analysis-img"></div>
                <div style="margin-top:2rem"><h3>Waveform</h3><img src="${data.waveform_url}" class="analysis-img"></div>
            `;
        }

        function renderStems(stems) {
            const container = document.getElementById('result-isolation').querySelector('.stems-container');
            container.innerHTML = '';
            Object.entries(stems).forEach(([label, url]) => {
                const row = document.createElement('div');
                row.className = 'stem-player';
                row.innerHTML = `<div class="stem-name">${label}</div><audio controls src="${url}"></audio>`;
                container.appendChild(row);
            });
        }

        // Mixer Logic
        function setupMixer(stems) {
            const container = document.getElementById('mixer-tracks');
            const existingStems = Array.from(container.querySelectorAll('.track-strip')).map(s => s.dataset.label);
            const newStems = Object.keys(stems);

            // Only rebuild if the labels changed
            if (JSON.stringify(existingStems) === JSON.stringify(newStems)) return;

            container.innerHTML = '';
            newStems.forEach(label => {
                createTrackStrip(label, container);
            });
        }

        function createTrackStrip(label, container) {
            const strip = document.createElement('div');
            strip.className = 'track-strip';
            strip.dataset.label = label;
            strip.innerHTML = `
                <div class="track-name">${label}</div>
                
                <div class="control-group">
                    <div class="control-label"><span>Vol</span> <span class="val">1.0</span></div>
                    <input type="range" class="control-slider vol-slider" min="0" max="2" step="0.1" value="1.0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Speed</span> <span class="val">1.0</span>x</div>
                    <input type="range" class="control-slider speed-slider" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Pitch</span> <span class="val">0</span> st</div>
                    <input type="range" class="control-slider pitch-slider" min="-12" max="12" step="1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Distort</span> <span class="val">0</span>%</div>
                    <input type="range" class="control-slider dist-slider" min="0" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Echo</span> <span class="val">0</span>%</div>
                    <input type="range" class="control-slider echo-slider" min="0" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>LPF</span> <span class="val">20k</span>Hz</div>
                    <input type="range" class="control-slider lpf-slider" min="100" max="20000" step="100" value="20000">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>HPF</span> <span class="val">20</span>Hz</div>
                    <input type="range" class="control-slider hpf-slider" min="20" max="5000" step="50" value="20">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Reverb</span> <span class="val">0</span></div>
                    <input type="range" class="control-slider reverb-slider" min="0" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Pan</span> <span class="val">0</span></div>
                    <input type="range" class="control-slider pan-slider" min="-1" max="1" step="0.1" value="0">
                </div>
            `;

            strip.querySelectorAll('input').forEach(input => {
                input.oninput = (e) => {
                    let val = e.target.value;
                    if (val >= 1000) val = (val / 1000).toFixed(1) + 'k';
                    e.target.previousElementSibling.querySelector('.val').textContent = val;
                };
            });

            container.appendChild(strip);
        }

        function getTrackData(strip, url) {
            return {
                url: url,
                volume: parseFloat(strip.querySelector('.vol-slider').value),
                speed: parseFloat(strip.querySelector('.speed-slider').value),
                pitch: parseFloat(strip.querySelector('.pitch-slider').value),
                distortion: parseFloat(strip.querySelector('.dist-slider').value),
                echo: parseFloat(strip.querySelector('.echo-slider').value),
                lpf: parseFloat(strip.querySelector('.lpf-slider').value),
                hpf: parseFloat(strip.querySelector('.hpf-slider').value),
                reverb: parseFloat(strip.querySelector('.reverb-slider').value),
                pan: parseFloat(strip.querySelector('.pan-slider').value)
            };
        }

        document.getElementById('btn-render-mix').onclick = async () => {
            const btn = document.getElementById('btn-render-mix');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            const tracks = [];
            document.querySelectorAll('#mixer-tracks .track-strip').forEach(strip => {
                const label = strip.dataset.label;
                tracks.push(getTrackData(strip, session.stems[label]));
            });

            try {
                const res = await fetch('/process/mix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tracks })
                });
                const data = await res.json();
                const preview = document.getElementById('master-preview');
                preview.src = data.mix_url;
                document.getElementById('render-result').style.display = 'block';
                preview.play();
            } catch (err) { alert(err.message); }
            finally {
                btn.disabled = false;
                btn.textContent = "Render Mix";
            }
        };


        document.getElementById('btn-process-single').onclick = async () => {
            const btn = document.getElementById('btn-process-single');
            btn.disabled = true;
            btn.textContent = "Processing...";

            const strip = document.getElementById('editor-track').querySelector('.track-strip');
            const track = getTrackData(strip, "/uploads/" + session.filename);

            try {
                const res = await fetch('/process/mix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tracks: [track] })
                });
                const data = await res.json();
                const preview = document.getElementById('single-preview');
                preview.src = data.mix_url;
                document.getElementById('single-result').style.display = 'block';
                preview.play();
            } catch (err) { alert(err.message); }
            finally {
                btn.disabled = false;
                btn.textContent = "Apply & Export";
            }
        };

    </script>
</body>