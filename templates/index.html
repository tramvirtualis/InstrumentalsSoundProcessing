<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-music"></i>
            RockSound
        </div>
        <ul class="menu">
            <li class="menu-item active" data-target="view-dashboard">
                <i class="fa-solid fa-house"></i>
                Dashboard
            </li>
            <li class="menu-item" data-target="view-noise">
                <i class="fa-solid fa-sliders"></i>
                Noise Reduction
            </li>
            <li class="menu-item" data-target="view-isolation">
                <i class="fa-solid fa-guitar"></i>
                Instrument Isolation
            </li>
            <li class="menu-item" data-target="view-spectrogram">
                <i class="fa-solid fa-microscope"></i>
                Audio Analysis
            </li>
            <li class="menu-item" data-target="view-stems">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                Effects Studio
            </li>
            <li class="menu-item">
                <i class="fa-solid fa-gear"></i>
                Settings
            </li>
        </ul>
    </div>

    <div class="main-content">
        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-section active">
            <header>
                <div>
                    <h1>Dashboard</h1>
                    <p class="subtitle">Welcome to your Rock Sound Analysis Studio</p>
                </div>
            </header>
            <div class="card-grid">
                <div class="card" onclick="switchView('view-spectrogram')">
                    <div class="card-icon">
                        <i class="fa-solid fa-microscope"></i>
                    </div>
                    <h3>Audio Analysis</h3>
                    <p>BPM, Key & Spectrogram</p>
                </div>

                <div class="card" onclick="switchView('view-noise')">
                    <div class="card-icon">
                        <i class="fa-solid fa-ear-muffs"></i>
                    </div>
                    <h3>Noise Reduction</h3>
                    <p>Remove background noise.</p>
                </div>

                <div class="card" onclick="switchView('view-isolation')">
                    <div class="card-icon">
                        <i class="fa-solid fa-guitar"></i>
                    </div>
                    <h3>Instrument Isolation</h3>
                    <p>Separate Vocals, Guitar, Drums & Bass.</p>
                </div>

                <div class="card" onclick="switchView('view-stems')">
                    <div class="card-icon">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </div>
                    <h3>Effects Studio</h3>
                    <p>Pitch, Speed & Pro Mixing.</p>
                </div>
            </div>
        </div>

        <!-- Spectrogram/Analysis View -->
        <div id="view-spectrogram" class="view-section">
            <header>
                <h1>Audio Analysis</h1>
                <p class="subtitle">Extract technical insights from your audio</p>
            </header>
            <div class="upload-area" id="upload-spectrogram">
                <i class="fa-solid fa-microscope"></i>
                <h3>Upload for Analysis</h3>
                <p>BPM, Key, Spectrogram & Waveform</p>
                <input type="file" id="file-spectrogram" hidden accept="audio/*">
            </div>
            <div id="result-spectrogram" class="analysis-results" style="display:none; margin-top: 2rem;">
                <p class="status-text">Processing...</p>
                <div class="analysis-content"></div>
            </div>
        </div>

        <!-- Noise Reduction View -->
        <div id="view-noise" class="view-section">
            <header>
                <h1>Noise Reduction</h1>
            </header>
            <div class="upload-area" id="upload-noise">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <h3>Click to Upload Track for Clean Up</h3>
                <p>Supports MP3, WAV, FLAC</p>
                <input type="file" id="file-noise" hidden accept="audio/*">
            </div>
            <div id="result-noise" style="margin-top: 2rem; display:none;">
                <h3>Cleaned Audio</h3>
                <p class="status-text">Processing...</p>
                <div class="audio-container" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Isolation View -->
        <div id="view-isolation" class="view-section">
            <header>
                <h1>Instrument Isolation</h1>
            </header>
            <div class="upload-area" id="upload-isolation">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <h3>Click to Upload Track for Separation</h3>
                <p>Separate Drums, Bass, and Other</p>
                <input type="file" id="file-isolation" hidden accept="audio/*">
            </div>
            <div id="result-isolation" style="margin-top: 2rem; display:none;">
                <h3>Separated Stems</h3>
                <p class="status-text">Processing...</p>
                <div class="stems-container" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Stems Mixing View -->
        <div id="view-stems" class="view-section">
            <header>
                <h1>Effects Studio</h1>
                <p class="subtitle">Fine-tune your audio with professional effects</p>
            </header>

            <div class="upload-area" id="upload-effects">
                <i class="fa-solid fa-file-audio"></i>
                <h3>Click to Upload Audio for Effects</h3>
                <p>Apply Pitch, Volume, Pan, and Reverb</p>
                <input type="file" id="file-effects" hidden accept="audio/*">
            </div>

            <div id="effects-editor" style="display:none; margin-top: 2rem;">
                <div class="mixer-tracks" id="editor-track">
                    <!-- Controls for the single file -->
                </div>

                <div class="mixer-master">
                    <h3>Process Result</h3>
                    <div id="master-controls">
                        <button class="btn-primary" id="btn-process-effect">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Apply & Export
                        </button>
                        <div id="effect-result" style="margin-top: 1rem; display:none;">
                            <p>Processed Audio:</p>
                            <audio id="effect-preview" controls style="width: 100%;"></audio>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keep the multi-stem mixer container but separate it slightly or allow reuse -->
            <div id="mixer-container" style="display:none; margin-top: 2rem;">
                <h3>Multi-Stem Mixer</h3>
                <div class="mixer-tracks" id="mixer-tracks">
                    <!-- Stem controls will be injected here -->
                </div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-render-mix">
                        <i class="fa-solid fa-file-export"></i> Render & Export Mix
                    </button>
                    <div id="render-result" style="margin-top: 1rem; display:none;">
                        <audio id="master-preview" controls style="width: 100%;"></audio>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Navigation Logic
        const menuItems = document.querySelectorAll('.menu-item');
        const sections = document.querySelectorAll('.view-section');

        function switchView(targetId) {
            // Update active section
            sections.forEach(section => {
                section.classList.remove('active');
                if (section.id === targetId) section.classList.add('active');
            });

            // Update active menu item
            menuItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.target === targetId) item.classList.add('active');
            });
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const target = item.dataset.target;
                if (target) switchView(target);
            });
        });

        // Generic Upload & Process Handler
        async function handleProcess(fileInputId, endpoint, resultContainerId, renderCallback) {
            const fileInput = document.getElementById(fileInputId);
            const resultContainer = document.getElementById(resultContainerId);
            const statusText = resultContainer.querySelector('.status-text');

            fileInput.onchange = async (e) => {
                if (!e.target.files.length) return;
                const file = e.target.files[0];

                // UI Updates
                resultContainer.style.display = 'block';
                if (statusText) {
                    statusText.textContent = `Uploading ${file.name}...`;
                    statusText.style.display = 'block';
                    statusText.style.color = 'var(--text)';
                }

                let contentDiv = resultContainer.querySelector('div') || resultContainer;
                if (contentDiv && contentDiv !== resultContainer) contentDiv.innerHTML = '';
                else if (contentDiv === resultContainer) {
                    // If no child div, clear everything except statusText
                    Array.from(resultContainer.children).forEach(child => {
                        if (!child.classList.contains('status-text') && child.tagName !== 'H3') {
                            child.remove();
                        }
                    });
                }

                // 1. Upload
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const upRes = await fetch('/upload', { method: 'POST', body: formData });
                    const upData = await upRes.json();
                    if (!upRes.ok) throw new Error(upData.error || 'Upload failed');

                    // 2. Process
                    if (statusText) statusText.textContent = 'Processing...';
                    const procRes = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: upData.filename })
                    });
                    const procData = await procRes.json();
                    if (!procRes.ok) throw new Error(procData.error || 'Processing failed');

                    if (statusText) statusText.textContent = 'Complete';
                    renderCallback(contentDiv, procData);

                } catch (err) {
                    if (statusText) {
                        statusText.textContent = 'Error: ' + err.message;
                        statusText.style.color = '#f78166';
                    } else {
                        alert('Error: ' + err.message);
                    }
                } finally {
                    fileInput.value = ''; // Reset
                }
            };

            fileInput.click();
        }

        // Setup Event Listeners
        document.getElementById('upload-spectrogram').addEventListener('click', () => {
            handleProcess('file-spectrogram', '/analyze/spectrogram', 'result-spectrogram', (container, data) => {
                container.innerHTML = `
                    <div class="analysis-grid">
                        <div class="stat-card"><span class="label">BPM</span><span class="value">${data.bpm}</span></div>
                        <div class="stat-card"><span class="label">Key</span><span class="value">${data.key}</span></div>
                        <div class="stat-card"><span class="label">Duration</span><span class="value">${data.duration}s</span></div>
                        <div class="stat-rate stat-card"><span class="label">Sample Rate</span><span class="value">${data.sample_rate}Hz</span></div>
                    </div>
                    <div>
                        <h3>Spectrogram (Log-F)</h3>
                        <img src="${data.spectrogram_url}" class="analysis-img">
                    </div>
                    <div style="margin-top: 2rem;">
                        <h3>Waveform Envelope</h3>
                        <img src="${data.waveform_url}" class="analysis-img">
                    </div>
                `;
            });
        });

        document.getElementById('upload-noise').addEventListener('click', () => {
            handleProcess('file-noise', '/analyze/denoise', 'result-noise', (container, data) => {
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.src = data.audio_url;
                audio.style.width = '100%';
                container.appendChild(audio);
            });
        });

        let currentStems = {};
        let currentFilename = "";

        // Setup Isolation handling to populate Mixer
        document.getElementById('upload-isolation').addEventListener('click', () => {
            handleProcess('file-isolation', '/analyze/isolation', 'result-isolation', (container, data) => {
                container.innerHTML = '';
                currentStems = data.stems || {};

                if (Object.keys(currentStems).length === 0) {
                    container.innerHTML = '<p style="color: #f78166;">No significant instruments detected.</p>';
                    return;
                }

                // Render in Isolation view
                Object.entries(currentStems).forEach(([label, url]) => {
                    const row = document.createElement('div');
                    row.className = 'stem-player';
                    row.innerHTML = `
                        <div class="stem-name">${label}</div>
                        <audio controls src="${url}"></audio>
                    `;
                    container.appendChild(row);
                });

                // Prepare Mixer
                setupMixer(currentStems);
            });
        });

        let currentEditorFile = "";

        function createTrackStrip(label, container) {
            const strip = document.createElement('div');
            strip.className = 'track-strip';
            strip.innerHTML = `
                <div class="track-name">${label}</div>
                
                <div class="control-group">
                    <div class="control-label"><span>Volume</span><span class="val">1.0</span></div>
                    <input type="range" class="control-slider vol-slider" min="0" max="2" step="0.1" value="1.0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Speed</span><span class="val">1.0</span>x</div>
                    <input type="range" class="control-slider speed-slider" min="0.5" max="2.0" step="0.1" value="1.0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Pitch</span><span class="val">0</span></div>
                    <input type="range" class="control-slider pitch-slider" min="-12" max="12" step="1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Pan</span><span class="val">0</span></div>
                    <input type="range" class="control-slider pan-slider" min="-1" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Distortion</span><span class="val">0</span></div>
                    <input type="range" class="control-slider distortion-slider" min="0" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Echo</span><span class="val">0</span></div>
                    <input type="range" class="control-slider echo-slider" min="0" max="1" step="0.1" value="0">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>Low-Pass</span><span class="val">20000</span>Hz</div>
                    <input type="range" class="control-slider lpf-slider" min="20" max="20000" step="100" value="20000">
                </div>

                <div class="control-group">
                    <div class="control-label"><span>High-Pass</span><span class="val">20</span>Hz</div>
                    <input type="range" class="control-slider hpf-slider" min="20" max="10000" step="100" value="20">
                </div>

                <div class="control-group">
                    <label style="font-size: 0.75rem; display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                        <input type="checkbox" class="reverb-toggle"> Reverb
                    </label>
                </div>
            `;
            strip.querySelectorAll('.control-slider').forEach(slider => {
                slider.oninput = (e) => { e.target.parentElement.querySelector('.val').textContent = e.target.value; };
            });
            container.appendChild(strip);
            return strip;
        }

        // Helper to collect track data from a strip
        function getTrackData(strip, url, label) {
            return {
                url: url,
                label: label || strip.querySelector('.track-name').textContent,
                volume: parseFloat(strip.querySelector('.vol-slider').value),
                speed: parseFloat(strip.querySelector('.speed-slider').value),
                pitch: parseFloat(strip.querySelector('.pitch-slider').value),
                pan: parseFloat(strip.querySelector('.pan-slider').value),
                distortion: parseFloat(strip.querySelector('.distortion-slider').value),
                echo: parseFloat(strip.querySelector('.echo-slider').value),
                lpf: parseFloat(strip.querySelector('.lpf-slider').value),
                hpf: parseFloat(strip.querySelector('.hpf-slider').value),
                reverb: strip.querySelector('.reverb-toggle').checked
            };
        }

        // Standalone Effect Studio Upload
        document.getElementById('upload-effects').addEventListener('click', () => {
            const fileInput = document.getElementById('file-effects');
            fileInput.click();
            fileInput.onchange = async (e) => {
                if (!e.target.files.length) return;
                const file = e.target.files[0];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/upload', { method: 'POST', body: formData });
                    const data = await res.json();
                    currentEditorFile = `/uploads/${data.filename}`;

                    document.getElementById('effects-editor').style.display = 'block';
                    const container = document.getElementById('editor-track');
                    container.innerHTML = '';
                    createTrackStrip(file.name, container);

                } catch (err) { alert('Upload failed'); }
            };
        });

        // Standalone Process Button
        document.getElementById('btn-process-effect').addEventListener('click', async () => {
            const btn = document.getElementById('btn-process-effect');
            const strip = document.querySelector('#editor-track .track-strip');
            if (!strip) return;

            const tracksData = [getTrackData(strip, currentEditorFile, "Main Track")];

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';

            try {
                const res = await fetch('/process/mix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stems: tracksData })
                });
                const data = await res.json();
                document.getElementById('effect-result').style.display = 'block';
                document.getElementById('effect-preview').src = data.mix_url;
            } catch (err) { alert(err.message); }
            finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Apply & Export';
            }
        });

        function setupMixer(stems) {
            const mixerContainer = document.getElementById('mixer-container');
            const mixerTracks = document.getElementById('mixer-tracks');
            mixerTracks.innerHTML = '';
            mixerContainer.style.display = 'block';

            Object.entries(stems).forEach(([label, url]) => {
                createTrackStrip(label, mixerTracks);
            });
        }

        document.getElementById('btn-render-mix').addEventListener('click', async () => {
            const btn = document.getElementById('btn-render-mix');
            const mixerTracks = document.querySelectorAll('#mixer-tracks .track-strip');
            const tracksData = [];

            mixerTracks.forEach(strip => {
                const label = strip.querySelector('.track-name').textContent;
                tracksData.push(getTrackData(strip, currentStems[label], label));
            });

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Rendering...';

            try {
                const res = await fetch('/process/mix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stems: tracksData })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Mix failed');

                const resultDiv = document.getElementById('render-result');
                const preview = document.getElementById('master-preview');
                resultDiv.style.display = 'block';
                preview.src = data.mix_url;
                preview.play();

            } catch (err) {
                alert('Mix Error: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-file-export"></i> Render & Export Mix';
            }
        });

    </script>
</body>