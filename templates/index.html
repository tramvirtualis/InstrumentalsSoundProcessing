<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-music"></i>
            RockSound
        </div>
        <ul class="menu">
            <li class="menu-item active" data-target="view-dashboard">
                <i class="fa-solid fa-house"></i>
                Trang chủ
            </li>
            <li class="menu-item" data-target="view-isolation">
                <i class="fa-solid fa-guitar"></i>
                Tách nhạc cụ
            </li>
            <li class="menu-item" data-target="view-stems">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                Phòng thu hiệu ứng
            </li>
            <li class="menu-item" data-target="view-voice">
                <i class="fa-solid fa-wave-square"></i>
                Phân tích chuyên sâu
            </li>
        </ul>
    </div>

    <div class="main-content">
        <!-- Global Session Bar -->
        <div id="session-bar" class="session-bar" style="display:none;">
            <div class="session-info">
                <i class="fa-solid fa-file-audio"></i>
                <span id="active-filename">Chưa chọn tệp</span>
            </div>
            <button class="btn-reset" onclick="resetSession()">
                <i class="fa-solid fa-rotate-left"></i> Đặt lại & Chọn tệp mới
            </button>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-section active">
            <header>
                <h1>Chào mừng đến với RockSound</h1>
                <p class="subtitle">Phòng thu xử lý âm thanh chuyên nghiệp dành cho bạn</p>
            </header>

            <div id="main-upload-area" class="upload-area">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <h3>Bắt đầu tại đây: Tải lên bản nhạc của bạn</h3>
                <p>Hỗ trợ định dạng MP3, WAV, FLAC</p>
                <input type="file" id="file-main" hidden accept="audio/*">
            </div>

            <div class="card-grid" id="dashboard-features" style="display:none;">
                <div class="card" onclick="switchView('view-voice')">
                    <div class="card-icon"><i class="fa-solid fa-microscope"></i></div>
                    <h3>Phân tích chuyên sâu</h3>
                    <p style="font-size:0.8rem; color:#888;">Xem chi tiết tần số & bồi âm</p>
                </div>
                <div class="card" onclick="switchView('view-isolation')">
                    <div class="card-icon"><i class="fa-solid fa-guitar"></i></div>
                    <h3>Tách nhạc cụ</h3>
                    <p style="font-size:0.8rem; color:#888;">Tách trống, bass, vocal...</p>
                </div>
                <div class="card" onclick="switchView('view-stems')">
                    <div class="card-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <h3>Hiệu ứng</h3>
                    <p style="font-size:0.8rem; color:#888;">Chỉnh sửa & Mix nhạc</p>
                </div>
            </div>
        </div>



        <!-- Isolation View -->
        <div id="view-isolation" class="view-section">
            <header>
                <h1>Tách các thành phần bản nhạc</h1>
                <p class="subtitle">Sử dụng thuật toán AI để tách Guitar, Trống, Bass và Lời hát</p>
            </header>
            <div id="isolation-placeholder" class="empty-state">
                <i class="fa-solid fa-guitar"></i>
                <h3>Sẵn sàng tách nhạc cụ</h3>
                <button class="btn-primary" id="btn-run-isolation">Bắt đầu tách ngay</button>
            </div>
            <div id="result-isolation" class="analysis-results" style="display:none;">
                <div class="stems-container"></div>
            </div>
        </div>

        <!-- Stems Mixing View -->
        <div id="view-stems" class="view-section">
            <header>
                <h1>Phòng thu hiệu ứng</h1>
                <p class="subtitle">Áp dụng hiệu ứng chuyên nghiệp cho bản thu của bạn</p>
            </header>

            <div id="studio-mode-selector" class="studio-toggle-container" style="display:none;">
                <button class="toggle-btn active" id="btn-mode-stems">Nhạc cụ đã tách</button>
                <button class="toggle-btn" id="btn-mode-single">Bản gốc</button>
            </div>

            <div id="mixer-placeholder" class="empty-state">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <h3>Hiệu ứng & Trộn nhạc (Mixing)</h3>
                <p>Chọn chế độ làm việc phía trên để bắt đầu</p>
                <div style="display:flex; gap:1rem; margin-top:1rem;">
                    <button class="btn-primary" onclick="setStudioMode('single')">Xử lý bản gốc</button>
                    <button class="btn-secondary" onclick="switchView('view-isolation')">Đi đến Tách nhạc cụ
                        trước</button>
                </div>
            </div>

            <div id="effects-editor" style="display:none;">
                <div class="mixer-tracks" id="editor-track"></div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-process-single">Áp dụng & Xuất tệp</button>
                    <div id="single-result" style="display:none; margin-top: 1rem;"><audio controls id="single-preview"
                            style="width:100%"></audio></div>
                </div>
            </div>

            <div id="mixer-container" style="display:none;">
                <div class="mixer-tracks" id="mixer-tracks"></div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-render-mix">Xuất bản Mix thành phẩm</button>
                    <div id="render-result" style="display:none; margin-top: 1rem;"><audio controls id="master-preview"
                            style="width:100%"></audio></div>
                </div>
            </div>
        </div>

        <!-- Advanced Analysis View -->
        <div id="view-voice" class="view-section">
            <header>
                <h1>Phân tích chuyên sâu</h1>
                <p class="subtitle">Áp dụng các kỹ thuật xử lý tín hiệu âm thanh tiên tiến</p>
            </header>

            <div id="voice-placeholder" class="empty-state">
                <i class="fa-solid fa-wave-square"></i>
                <h3>Ready for Advanced Analysis</h3>
                <p>Áp dụng các kỹ thuật LPC, Formant, Pitch Tracking</p>
            </div>

            <div id="voice-analysis-container" style="display:none;">
                <!-- Analysis Buttons -->
                <div class="voice-controls"
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:1.5rem; margin-bottom:2rem;">

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-lpc-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-chart-line"></i> Phân tích LPC
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">Mô phỏng nguồn âm thanh và bộ lọc cộng hưởng
                            của nhạc cụ.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-waveform-analysis"
                            style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-water"></i> Dạng sóng (Waveform)
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">Hình ảnh trực quan về biên độ âm thanh theo
                            thời gian.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-formant-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-mountain"></i> Bồi âm (Harmonics)
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">Xác định các đỉnh tần số tạo nên màu sắc đặc
                            trưng của âm thanh.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-pitch-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-music"></i> Theo dõi cao độ
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">Dò tìm nốt nhạc và sự thay đổi tần số chính
                            xác theo thời gian.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-detailed-spec" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-image"></i> Phổ chi tiết
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">Biểu đồ FFT độ phân giải cao cho cái nhìn
                            sâu sắc nhất.</p>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="voice-results">
                    <!-- LPC Results -->
                    <div id="lpc-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-chart-line"></i> Linear Predictive Coding Analysis</h3>
                        <div class="lpc-content"></div>
                    </div>

                    <!-- Waveform Results -->
                    <div id="waveform-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-water"></i> Waveform Visualization</h3>
                        <canvas id="waveform-canvas" width="800" height="300"
                            style="width:100%; border:1px solid #333; border-radius:8px;"></canvas>
                        <div class="waveform-info" style="margin-top:1rem;"></div>
                    </div>

                    <!-- Formant Results -->
                    <div id="formant-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-mountain"></i> Formant Analysis</h3>
                        <div class="formant-content"></div>
                    </div>

                    <!-- Pitch Results -->
                    <div id="pitch-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-music"></i> Pitch Tracking</h3>
                        <canvas id="pitch-canvas" width="800" height="300"
                            style="width:100%; border:1px solid #333; border-radius:8px;"></canvas>
                        <div class="pitch-info" style="margin-top:1rem;"></div>
                    </div>

                    <!-- Detailed Spectrogram Results -->
                    <div id="detailed-spec-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-image"></i> Detailed Spectrogram (FFT-based)</h3>
                        <div class="spec-content"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global Session State
        let session = {
            filename: "",
            analysis: null,
            stems: null,
            studioMode: "stems" // 'stems' or 'single'
        };

        // Navigation Logic
        const menuItems = document.querySelectorAll('.menu-item');
        const sections = document.querySelectorAll('.view-section');

        function switchView(targetId) {
            sections.forEach(sec => {
                sec.classList.remove('active');
                if (sec.id === targetId) sec.classList.add('active');
            });
            menuItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.target === targetId) item.classList.add('active');
            });
            updateSessionUI(); // Sync UI whenever switching tabs
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const target = item.dataset.target;
                if (target) switchView(target);
            });
        });

        // Initialize Upload
        const mainUploadArea = document.getElementById('main-upload-area');
        const fileMain = document.getElementById('file-main');

        mainUploadArea.addEventListener('click', () => fileMain.click());

        fileMain.onchange = async (e) => {
            if (!e.target.files.length) return;
            const file = e.target.files[0];

            // 1. Show Loading on Dashboard
            mainUploadArea.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i><h3>Uploading ${file.name}...</h3>`;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Upload failed");

                session.filename = data.filename;
                updateSessionUI();
            } catch (err) {
                alert(err.message);
                resetSession();
            }
        };

        function updateSessionUI() {
            const hasFile = !!session.filename;
            console.log("Updating UI. File:", session.filename, "Stems:", !!session.stems);

            // Session Bar
            const elSessionBar = document.getElementById('session-bar');
            if (elSessionBar) elSessionBar.style.display = hasFile ? 'flex' : 'none';
            const elActiveFile = document.getElementById('active-filename');
            if (elActiveFile) elActiveFile.textContent = session.filename || "Chưa chọn tệp";

            // Dashboard
            const elUpload = document.getElementById('main-upload-area');
            const elFeatures = document.getElementById('dashboard-features');
            if (elUpload) elUpload.style.display = hasFile ? 'none' : 'flex';
            if (elFeatures) elFeatures.style.display = hasFile ? 'grid' : 'none';

            // Isolation
            const elIsoPH = document.getElementById('isolation-placeholder');
            const elIsoRes = document.getElementById('result-isolation');
            if (elIsoPH) elIsoPH.style.display = (hasFile && !session.stems) ? 'flex' : 'none';
            if (elIsoRes) elIsoRes.style.display = session.stems ? 'block' : 'none';

            // Advanced Analysis
            const elVoicePH = document.getElementById('voice-placeholder');
            const elVoiceCont = document.getElementById('voice-analysis-container');
            if (elVoicePH) elVoicePH.style.display = hasFile ? 'none' : 'flex';
            if (elVoiceCont) elVoiceCont.style.display = hasFile ? 'block' : 'none';

            // Studio
            const elStudioModeSec = document.getElementById('studio-mode-selector');
            if (elStudioModeSec) elStudioModeSec.style.display = hasFile ? 'flex' : 'none';

            const mode = session.studioMode;
            const btnStems = document.getElementById('btn-mode-stems');
            const btnSingle = document.getElementById('btn-mode-single');
            if (btnStems) btnStems.classList.toggle('active', mode === 'stems');
            if (btnSingle) btnSingle.classList.toggle('active', mode === 'single');

            const pleader = document.getElementById('mixer-placeholder');
            const meditor = document.getElementById('effects-editor');
            const mcontainer = document.getElementById('mixer-container');

            if (pleader) pleader.style.display = 'none';
            if (meditor) meditor.style.display = 'none';
            if (mcontainer) mcontainer.style.display = 'none';

            if (mode === 'stems') {
                if (session.stems) {
                    if (mcontainer) mcontainer.style.display = 'block';
                    setupMixer(session.stems);
                } else {
                    if (pleader) {
                        pleader.style.display = 'flex';
                        const p = pleader.querySelector('p');
                        if (p) p.textContent = "Vui lòng tách nhạc cụ trước khi sử dụng bộ trộn đa kênh.";
                    }
                }
            } else {
                if (meditor) {
                    meditor.style.display = 'block';
                    const container = document.getElementById('editor-track');
                    if (container && container.children.length === 0) {
                        createTrackStrip("Bản gốc", container);
                    }
                }
            }
        }

        function setStudioMode(mode) {
            session.studioMode = mode;
            updateSessionUI();
        }

        const btnModeStems = document.getElementById('btn-mode-stems');
        if (btnModeStems) btnModeStems.onclick = () => setStudioMode('stems');
        const btnModeSingle = document.getElementById('btn-mode-single');
        if (btnModeSingle) btnModeSingle.onclick = () => setStudioMode('single');

        function resetSession() {
            session = { filename: "", analysis: null, stems: null };
            const fileInput = document.getElementById('file-main');
            if (fileInput) fileInput.value = '';

            const uploadArea = document.getElementById('main-upload-area');
            if (uploadArea) {
                uploadArea.innerHTML = `<i class="fa-solid fa-cloud-arrow-up"></i><h3>Tải lên bản nhạc của bạn</h3><p>Hỗ trợ MP3, WAV, FLAC</p>`;
            }

            // Clear results
            const isoResult = document.getElementById('result-isolation');
            if (isoResult) {
                const container = isoResult.querySelector('.stems-container');
                if (container) container.innerHTML = '';
            }

            const mixerTracks = document.getElementById('mixer-tracks');
            const editorTrack = document.getElementById('editor-track');
            if (mixerTracks) mixerTracks.innerHTML = '';
            if (editorTrack) editorTrack.innerHTML = '';

            updateSessionUI();
            switchView('view-dashboard');
        }

        // --- Core Actions ---

        const btnIsolation = document.getElementById('btn-run-isolation');
        if (btnIsolation) {
            btnIsolation.onclick = async () => {
                const btn = btnIsolation;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';

                try {
                    const res = await fetch('/analyze/isolation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    session.stems = data.stems;
                    renderStems(data.stems);
                    updateSessionUI();
                } catch (err) {
                    alert("Lỗi tách nhạc: " + err.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = "Tách ngay";
                }
            };
        }

        function renderStems(stems) {
            const elResults = document.getElementById('result-isolation');
            if (!elResults) return;
            const container = elResults.querySelector('.stems-container');
            if (!container) return;
            container.innerHTML = '';
            Object.entries(stems).forEach(([label, url]) => {
                const row = document.createElement('div');
                row.className = 'stem-player';
                row.style = "background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;";
                row.innerHTML = `<div class="stem-name" style="min-width: 100px; font-weight: bold;">${label.toUpperCase()}</div><audio controls src="${url}" style="flex: 1;"></audio>`;
                container.appendChild(row);
            });
        }

        // --- Mixer Logic ---

        function setupMixer(stems) {
            const container = document.getElementById('mixer-tracks');
            if (!container) return;
            const existingStems = Array.from(container.querySelectorAll('.track-strip')).map(s => s.dataset.label);
            const newStems = Object.keys(stems);

            if (JSON.stringify(existingStems) === JSON.stringify(newStems)) return;

            container.innerHTML = '';
            newStems.forEach(label => {
                createTrackStrip(label, container);
            });
        }

        function createTrackStrip(label, container) {
            const strip = document.createElement('div');
            strip.className = 'track-strip';
            strip.dataset.label = label;
            strip.innerHTML = `
                <div class="track-name" style="font-weight: bold; margin-bottom: 1rem; color: #4CAF50;">${label.toUpperCase()}</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                    <div class="control-group">
                        <div class="control-label"><span>Âm lượng</span> <span class="val">1.0</span></div>
                        <input type="range" class="control-slider vol-slider" min="0" max="2" step="0.1" value="1.0">
                    </div>
                    <div class="control-group">
                        <div class="control-label"><span>Tốc độ</span> <span class="val">1.0</span>x</div>
                        <input type="range" class="control-slider speed-slider" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div class="control-group">
                        <div class="control-label"><span>Cao độ</span> <span class="val">0</span> st</div>
                        <input type="range" class="control-slider pitch-slider" min="-12" max="12" step="1" value="0">
                    </div>
                </div>
            `;

            strip.querySelectorAll('input').forEach(input => {
                input.oninput = (e) => {
                    let val = e.target.value;
                    const valEl = e.target.previousElementSibling.querySelector('.val');
                    if (valEl) valEl.textContent = val;
                };
            });

            container.appendChild(strip);
        }

        function getTrackData(strip, url) {
            return {
                url: url,
                volume: parseFloat(strip.querySelector('.vol-slider')?.value || 1.0),
                speed: parseFloat(strip.querySelector('.speed-slider')?.value || 1.0),
                pitch: parseFloat(strip.querySelector('.pitch-slider')?.value || 0),
                distortion: 0, echo: 0, lpf: 20000, hpf: 20, reverb: 0, pan: 0
            };
        }

        const btnRenderMix = document.getElementById('btn-render-mix');
        if (btnRenderMix) {
            btnRenderMix.onclick = async () => {
                const btn = btnRenderMix;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang kết xuất...';

                const tracks = [];
                document.querySelectorAll('#mixer-tracks .track-strip').forEach(strip => {
                    const label = strip.dataset.label;
                    tracks.push(getTrackData(strip, session.stems[label]));
                });

                try {
                    const res = await fetch('/process/mix', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tracks })
                    });
                    const data = await res.json();
                    const preview = document.getElementById('master-preview');
                    if (preview) {
                        preview.src = data.mix_url;
                        const resDiv = document.getElementById('render-result');
                        if (resDiv) resDiv.style.display = 'block';
                        preview.play();
                    }
                } catch (err) { alert(err.message); }
                finally {
                    btn.disabled = false;
                    btn.textContent = "Xuất bản Mix thành phẩm";
                }
            };
        }

        const btnProcessSingle = document.getElementById('btn-process-single');
        if (btnProcessSingle) {
            btnProcessSingle.onclick = async () => {
                const btn = btnProcessSingle;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';

                const stripCont = document.getElementById('editor-track');
                const strip = stripCont ? stripCont.querySelector('.track-strip') : null;
                if (!strip) return;

                const track = getTrackData(strip, "/uploads/" + session.filename);

                try {
                    const res = await fetch('/process/mix', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tracks: [track] })
                    });
                    const data = await res.json();
                    const preview = document.getElementById('single-preview');
                    if (preview) {
                        preview.src = data.mix_url;
                        const resDiv = document.getElementById('single-result');
                        if (resDiv) resDiv.style.display = 'block';
                        preview.play();
                    }
                } catch (err) { alert(err.message); }
                finally {
                    btn.disabled = false;
                    btn.textContent = "Áp dụng & Xuất tệp";
                }
            };
        }

        // --- Analysis Actions ---

        const btnLPC = document.getElementById('btn-lpc-analysis');
        if (btnLPC) {
            btnLPC.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';

                try {
                    const res = await fetch('/analyze/lpc', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    const container = document.getElementById('lpc-results');
                    if (container) {
                        const content = container.querySelector('.lpc-content');
                        if (content) {
                            content.innerHTML = `
                                <div style="background: rgba(76, 175, 80, 0.1); padding:1rem; border-radius:8px; margin-bottom:1.5rem;">
                                    <h4 style="margin:0; color:#4CAF50;">✅ Phân tích LPC hoàn tất</h4>
                                    <p style="margin:0.5rem 0 0 0; color:#999; font-size:0.9rem;">
                                        Tần số lấy mẫu: ${data.lpc_data.sample_rate}Hz | Bậc: ${data.lpc_data.order}
                                    </p>
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
                                    <div>
                                        <h4>Hệ số LPC (10 đầu)</h4>
                                        <div style="background:#1a1a1a; padding:1rem; border-radius:8px; overflow-x:auto;">
                                            <code style="color:#4CAF50; font-size:0.85rem;">
                                                ${data.lpc_data.lpc_coefficients.slice(0, 10).map((c, i) => `a[${i}] = ${c.toFixed(4)}`).join('<br>')}<br>...
                                            </code>
                                        </div>
                                    </div>
                                    <div>
                                        <h4>Đồ thị Tự tương quan</h4>
                                        <img src="${data.autocorrelation_plot}" style="width:100%; border-radius:8px; border:1px solid #333;">
                                    </div>
                                </div>
                            `;
                        }
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('Lỗi LPC: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-chart-line"></i> Phân tích LPC';
                }
            };
        }

        const btnWaveform = document.getElementById('btn-waveform-analysis');
        if (btnWaveform) {
            btnWaveform.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';

                try {
                    const res = await fetch('/analyze/waveform', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    const container = document.getElementById('waveform-results');
                    const canvas = document.getElementById('waveform-canvas');
                    if (canvas && container) {
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#0a0a0a';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.strokeStyle = '#FF9800';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        const pts = data.waveform.points;
                        const sx = canvas.width / 600;
                        const sy = canvas.height / 300;
                        pts.forEach((p, i) => {
                            const vx = p.x * sx;
                            const vy = canvas.height / 2 - p.y * sy;
                            if (i === 0) ctx.moveTo(vx, vy);
                            else ctx.lineTo(vx, vy);
                        });
                        ctx.stroke();
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('Lỗi Waveform: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-water"></i> Dạng sóng';
                }
            };
        }

        const btnHarmonics = document.getElementById('btn-formant-analysis');
        if (btnHarmonics) {
            btnHarmonics.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';
                try {
                    const res = await fetch('/analyze/formants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    const container = document.getElementById('formant-results');
                    if (container) {
                        const content = container.querySelector('.formant-content');
                        if (content) {
                            content.innerHTML = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:1rem;">
                                ${data.formants.map((f, i) => `<div class="stat-card">Bồi âm ${i + 1}<br><b>${f.frequency.toFixed(0)} Hz</b></div>`).join('')}
                            </div>`;
                        }
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('Lỗi Bồi âm: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-mountain"></i> Bồi âm';
                }
            };
        }

        const btnPitch = document.getElementById('btn-pitch-analysis');
        if (btnPitch) {
            btnPitch.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';
                try {
                    const res = await fetch('/analyze/pitch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    const container = document.getElementById('pitch-results');
                    if (container) {
                        const canvas = document.getElementById('pitch-canvas');
                        if (canvas && data.pitch_data.length > 0) {
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#0a0a0a';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.strokeStyle = '#4CAF50';
                            ctx.beginPath();
                            const freqs = data.pitch_data.map(p => p.frequency);
                            const minF = Math.min(...freqs);
                            const maxF = Math.max(...freqs);
                            const range = (maxF - minF) || 1;
                            data.pitch_data.forEach((p, i) => {
                                const px = (i / data.pitch_data.length) * canvas.width;
                                const py = canvas.height - ((p.frequency - minF) / range) * (canvas.height - 40) - 20;
                                if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                            });
                            ctx.stroke();
                        }
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('Lỗi Pitch: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-music"></i> Theo dõi cao độ';
                }
            };
        }

        const btnSpec = document.getElementById('btn-detailed-spec');
        if (btnSpec) {
            btnSpec.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Đang xử lý...';
                try {
                    const res = await fetch('/analyze/detailed_spectrogram', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    const container = document.getElementById('detailed-spec-results');
                    if (container) {
                        const content = container.querySelector('.spec-content');
                        if (content) content.innerHTML = `<img src="${data.spectrogram_url}" style="width:100%; border-radius:8px;">`;
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('Lỗi Phổ: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-image"></i> Phổ chi tiết';
                }
            };
        }

    </script>
</body>

</html>