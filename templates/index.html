<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-music"></i>
            RockSound
        </div>
        <ul class="menu">
            <li class="menu-item active" data-target="view-dashboard">
                <i class="fa-solid fa-house"></i>
                Trang ch·ªß
            </li>
            <li class="menu-item" data-target="view-isolation">
                <i class="fa-solid fa-guitar"></i>
                T√°ch nh·∫°c c·ª•
            </li>
            <li class="menu-item" data-target="view-stems">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                Ph√≤ng thu hi·ªáu ·ª©ng
            </li>
            <li class="menu-item" data-target="view-voice">
                <i class="fa-solid fa-wave-square"></i>
                Ph√¢n t√≠ch chuy√™n s√¢u
            </li>
        </ul>
    </div>

    <div class="main-content">
        <!-- Global Session Bar -->
        <div id="session-bar" class="session-bar" style="display:none;">
            <div class="session-info">
                <i class="fa-solid fa-file-audio"></i>
                <span id="active-filename">Ch∆∞a ch·ªçn t·ªáp</span>
            </div>
            <button class="btn-reset" onclick="resetSession()">
                <i class="fa-solid fa-rotate-left"></i> ƒê·∫∑t l·∫°i & Ch·ªçn t·ªáp m·ªõi
            </button>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-section active">
            <header>
                <h1>Ch√†o m·ª´ng ƒë·∫øn v·ªõi RockSound</h1>
                <p class="subtitle">Ph√≤ng thu x·ª≠ l√Ω √¢m thanh chuy√™n nghi·ªáp d√†nh cho b·∫°n</p>
            </header>

            <div id="main-upload-area" class="upload-area">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <h3>B·∫Øt ƒë·∫ßu t·∫°i ƒë√¢y: T·∫£i l√™n b·∫£n nh·∫°c c·ªßa b·∫°n</h3>
                <p>H·ªó tr·ª£ ƒë·ªãnh d·∫°ng MP3, WAV, FLAC</p>
                <input type="file" id="file-main" hidden accept="audio/*">
            </div>

            <div class="card-grid" id="dashboard-features" style="display:none;">
                <div class="card" onclick="switchView('view-voice')">
                    <div class="card-icon"><i class="fa-solid fa-microscope"></i></div>
                    <h3>Ph√¢n t√≠ch chuy√™n s√¢u</h3>
                    <p style="font-size:0.8rem; color:#888;">Xem chi ti·∫øt t·∫ßn s·ªë & b·ªìi √¢m</p>
                </div>
                <div class="card" onclick="switchView('view-isolation')">
                    <div class="card-icon"><i class="fa-solid fa-guitar"></i></div>
                    <h3>T√°ch nh·∫°c c·ª•</h3>
                    <p style="font-size:0.8rem; color:#888;">T√°ch tr·ªëng, bass, vocal...</p>
                </div>
                <div class="card" onclick="switchView('view-stems')">
                    <div class="card-icon"><i class="fa-solid fa-wand-magic-sparkles"></i></div>
                    <h3>Hi·ªáu ·ª©ng</h3>
                    <p style="font-size:0.8rem; color:#888;">Ch·ªânh s·ª≠a & Mix nh·∫°c</p>
                </div>
            </div>
        </div>



        <!-- Isolation View -->
        <div id="view-isolation" class="view-section">
            <header>
                <h1>T√°ch c√°c th√†nh ph·∫ßn b·∫£n nh·∫°c</h1>
                <p class="subtitle">S·ª≠ d·ª•ng thu·∫≠t to√°n AI ƒë·ªÉ t√°ch Guitar, Tr·ªëng, Bass v√† L·ªùi h√°t</p>
            </header>
            <div id="isolation-placeholder" class="empty-state">
                <i class="fa-solid fa-guitar"></i>
                <h3>S·∫µn s√†ng t√°ch nh·∫°c c·ª•</h3>
                <button class="btn-primary" id="btn-run-isolation">B·∫Øt ƒë·∫ßu t√°ch ngay</button>
            </div>
            <div id="result-isolation" class="analysis-results" style="display:none;">
                <div class="stems-container"></div>
            </div>
        </div>

        <!-- Stems Mixing View -->
        <div id="view-stems" class="view-section">
            <header>
                <h1>Ph√≤ng thu hi·ªáu ·ª©ng</h1>
                <p class="subtitle">√Åp d·ª•ng hi·ªáu ·ª©ng chuy√™n nghi·ªáp cho b·∫£n thu c·ªßa b·∫°n</p>
            </header>

            <div id="studio-mode-selector" class="studio-toggle-container" style="display:none;">
                <button class="toggle-btn active" id="btn-mode-stems">Nh·∫°c c·ª• ƒë√£ t√°ch</button>
                <button class="toggle-btn" id="btn-mode-single">B·∫£n g·ªëc</button>
            </div>

            <div id="mixer-placeholder" class="empty-state">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <h3>Hi·ªáu ·ª©ng & Tr·ªôn nh·∫°c (Mixing)</h3>
                <p>Ch·ªçn ch·∫ø ƒë·ªô l√†m vi·ªác ph√≠a tr√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                <div style="display:flex; gap:1rem; margin-top:1rem;">
                    <button class="btn-primary" onclick="setStudioMode('single')">X·ª≠ l√Ω b·∫£n g·ªëc</button>
                    <button class="btn-secondary" onclick="switchView('view-isolation')">ƒêi ƒë·∫øn T√°ch nh·∫°c c·ª•
                        tr∆∞·ªõc</button>
                </div>
            </div>

            <div id="effects-editor" style="display:none;">
                <div class="mixer-tracks" id="editor-track"></div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-process-single">√Åp d·ª•ng & Xu·∫•t t·ªáp</button>
                    <div id="single-result" style="display:none; margin-top: 1rem;"><audio controls id="single-preview"
                            style="width:100%"></audio></div>
                </div>
            </div>

            <div id="mixer-container" style="display:none;">
                <div class="mixer-tracks" id="mixer-tracks"></div>
                <div class="mixer-master">
                    <button class="btn-primary" id="btn-render-mix">Xu·∫•t b·∫£n Mix th√†nh ph·∫©m</button>
                    <div id="render-result" style="display:none; margin-top: 1rem;"><audio controls id="master-preview"
                            style="width:100%"></audio></div>
                </div>
            </div>
        </div>

        <!-- Advanced Analysis View -->
        <div id="view-voice" class="view-section">
            <header>
                <h1>Ph√¢n t√≠ch chuy√™n s√¢u</h1>
                <p class="subtitle">√Åp d·ª•ng c√°c k·ªπ thu·∫≠t x·ª≠ l√Ω t√≠n hi·ªáu √¢m thanh ti√™n ti·∫øn</p>
            </header>

            <div id="voice-placeholder" class="empty-state">
                <i class="fa-solid fa-wave-square"></i>
                <h3>Ready for Advanced Analysis</h3>
                <p>√Åp d·ª•ng c√°c k·ªπ thu·∫≠t LPC, Formant, Pitch Tracking</p>
            </div>

            <div id="voice-analysis-container" style="display:none;">
                <!-- Analysis Buttons -->
                <div class="voice-controls"
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:1.5rem; margin-bottom:2rem;">

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-lpc-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-chart-line"></i> Ph√¢n t√≠ch LPC
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">M√¥ ph·ªèng ngu·ªìn √¢m thanh v√† b·ªô l·ªçc c·ªông h∆∞·ªüng
                            c·ªßa nh·∫°c c·ª•.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-waveform-analysis"
                            style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-water"></i> D·∫°ng s√≥ng (Waveform)
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">H√¨nh ·∫£nh tr·ª±c quan v·ªÅ bi√™n ƒë·ªô √¢m thanh theo
                            th·ªùi gian.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-formant-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-mountain"></i> B·ªìi √¢m (Harmonics)
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">X√°c ƒë·ªãnh c√°c ƒë·ªânh t·∫ßn s·ªë t·∫°o n√™n m√†u s·∫Øc ƒë·∫∑c
                            tr∆∞ng c·ªßa √¢m thanh.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-pitch-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-music"></i> Theo d√µi cao ƒë·ªô
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">D√≤ t√¨m n·ªët nh·∫°c v√† s·ª± thay ƒë·ªïi t·∫ßn s·ªë ch√≠nh
                            x√°c theo th·ªùi gian.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-detailed-spec" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-image"></i> Ph·ªï chi ti·∫øt
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">Bi·ªÉu ƒë·ªì FFT ƒë·ªô ph√¢n gi·∫£i cao cho c√°i nh√¨n
                            s√¢u s·∫Øc nh·∫•t.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-zcr-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-wave-square"></i> T·∫ßn s·ªë c·∫Øt 0
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">Ph√¢n t√≠ch Zero-Crossing Rate ƒë·ªÉ ph√°t hi·ªán voiced/unvoiced.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-vad-analysis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-microphone"></i> Ph√°t hi·ªán √¢m thanh
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">VAD - T·ª± ƒë·ªông ph√°t hi·ªán v√† c·∫Øt ph·∫ßn l·∫∑ng.</p>
                    </div>

                    <div class="tool-card"
                        style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-primary" id="btn-lpc-synthesis" style="width:100%; margin-bottom:0.5rem;">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> T·ªïng h·ª£p t·ª´ LPC
                        </button>
                        <p style="font-size:0.85rem; color:#888; margin:0;">T·∫°o √¢m thanh nh√¢n t·∫°o t·ª´ LPC coefficients.</p>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="voice-results">
                    <!-- LPC Results -->
                    <div id="lpc-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-chart-line"></i> Linear Predictive Coding Analysis</h3>
                        <div class="lpc-content"></div>
                    </div>

                    <!-- Waveform Results -->
                    <div id="waveform-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-water"></i> Waveform Visualization</h3>
                        <canvas id="waveform-canvas" width="800" height="300"
                            style="width:100%; border:1px solid #333; border-radius:8px;"></canvas>
                        <div class="waveform-info" style="margin-top:1rem;"></div>
                    </div>

                    <!-- Formant Results -->
                    <div id="formant-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-mountain"></i> Formant Analysis</h3>
                        <div class="formant-content"></div>
                    </div>

                    <!-- Pitch Results -->
                    <div id="pitch-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-music"></i> Pitch Tracking</h3>
                        <canvas id="pitch-canvas" width="800" height="300"
                            style="width:100%; border:1px solid #333; border-radius:8px;"></canvas>
                        <div class="pitch-info" style="margin-top:1rem;"></div>
                    </div>

                    <!-- Detailed Spectrogram Results -->
                    <div id="detailed-spec-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-image"></i> Detailed Spectrogram (FFT-based)</h3>
                        <div class="spec-content"></div>
                    </div>

                    <!-- ZCR Results -->
                    <div id="zcr-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-wave-square"></i> Zero-Crossing Rate Analysis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="stat-box">
                                <div class="stat-label">Mean ZCR</div>
                                <div class="stat-value" id="zcr-mean">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Std Dev ZCR</div>
                                <div class="stat-value" id="zcr-std">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Max ZCR</div>
                                <div class="stat-value" id="zcr-max">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Min ZCR</div>
                                <div class="stat-value" id="zcr-min">-</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <p id="zcr-description" style="margin: 0; color: #ddd; font-size: 0.9rem;"></p>
                        </div>
                        <img id="zcr-plot" style="width: 100%; border-radius: 8px; border: 1px solid #333;">
                    </div>

                    <!-- VAD Results -->
                    <div id="vad-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-microphone"></i> Voice Activity Detection (Endpoint Detection)</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="stat-box">
                                <div class="stat-label">T·ªïng th·ªùi l∆∞·ª£ng</div>
                                <div class="stat-value" id="vad-total-duration">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Th·ªùi gian c√≥ √¢m thanh</div>
                                <div class="stat-value" id="vad-voice-time">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">T·ª∑ l·ªá √¢m thanh</div>
                                <div class="stat-value" id="vad-voice-ratio">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">S·ªë segments</div>
                                <div class="stat-value" id="vad-num-segments">-</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4CAF50;">
                            <h4 style="margin: 0 0 0.5rem 0; color: #4CAF50;">Voice Segments (Ph·∫ßn c√≥ √¢m thanh)</h4>
                            <div id="vad-segments-list" style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <img id="vad-plot" style="width: 100%; border-radius: 8px; border: 1px solid #333;">
                        </div>
                        <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <p style="margin: 0; color: #ddd; font-size: 0.9rem;">
                                <strong>üí° Th√¥ng tin:</strong> Ph·∫ßn xanh = √¢m thanh c√≥ voice, ph·∫ßn tr·∫Øng = silence. C√≥ th·ªÉ d√πng ƒë·ªÉ auto-trim ho·∫∑c split tracks.
                            </p>
                        </div>
                    </div>

                    <!-- LPC Synthesis Results -->
                    <div id="lpc-synth-results" class="analysis-card" style="display:none;">
                        <h3><i class="fa-solid fa-wand-magic-sparkles"></i> LPC Speech Synthesis</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="stat-box">
                                <div class="stat-label">Pitch Frequency</div>
                                <div class="stat-value" id="synth-pitch">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">LPC Order</div>
                                <div class="stat-value" id="synth-lpc-order">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Excitation Type</div>
                                <div class="stat-value" id="synth-excitation">-</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Similarity</div>
                                <div class="stat-value" id="synth-similarity">-</div>
                            </div>
                        </div>
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border-left: 4px solid #9C27B0;">
                            <p id="synth-description" style="margin: 0; color: #ddd; font-size: 0.9rem;"></p>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h4>üîä Synthesized Audio</h4>
                            <audio id="synth-audio" controls style="width: 100%; margin-bottom: 1rem;"></audio>
                        </div>
                        <div style="margin-bottom: 1.5rem;">
                            <h4>üìä Waveform & Spectrogram Comparison</h4>
                            <img id="synth-plot" style="width: 100%; border-radius: 8px; border: 1px solid #333;">
                        </div>
                        <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <p style="margin: 0; color: #ddd; font-size: 0.9rem;">
                                <strong>üí° ·ª®ng d·ª•ng:</strong> T·∫°o hi·ªáu ·ª©ng robot/alien, voice morphing, ho·∫∑c th·ª±c hi·ªán ƒë·∫∑c t√≠nh c·ªßa LPC analysis b·∫°n v·ª´a h·ªçc.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global Session State
        let session = {
            filename: "",
            analysis: null,
            stems: null,
            studioMode: "stems" // 'stems' or 'single'
        };

        // Navigation Logic
        const menuItems = document.querySelectorAll('.menu-item');
        const sections = document.querySelectorAll('.view-section');

        function switchView(targetId) {
            sections.forEach(sec => {
                sec.classList.remove('active');
                if (sec.id === targetId) sec.classList.add('active');
            });
            menuItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.target === targetId) item.classList.add('active');
            });
            updateSessionUI(); // Sync UI whenever switching tabs
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const target = item.dataset.target;
                if (target) switchView(target);
            });
        });

        // Initialize Upload
        const mainUploadArea = document.getElementById('main-upload-area');
        const fileMain = document.getElementById('file-main');

        mainUploadArea.addEventListener('click', () => fileMain.click());

        fileMain.onchange = async (e) => {
            if (!e.target.files.length) return;
            const file = e.target.files[0];

            // 1. Show Loading on Dashboard
            mainUploadArea.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i><h3>Uploading ${file.name}...</h3>`;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || "Upload failed");

                session.filename = data.filename;
                updateSessionUI();
            } catch (err) {
                alert(err.message);
                resetSession();
            }
        };

        function updateSessionUI() {
            const hasFile = !!session.filename;
            console.log("Updating UI. File:", session.filename, "Stems:", !!session.stems);

            // Session Bar
            const elSessionBar = document.getElementById('session-bar');
            if (elSessionBar) elSessionBar.style.display = hasFile ? 'flex' : 'none';
            const elActiveFile = document.getElementById('active-filename');
            if (elActiveFile) elActiveFile.textContent = session.filename || "Ch∆∞a ch·ªçn t·ªáp";

            // Dashboard
            const elUpload = document.getElementById('main-upload-area');
            const elFeatures = document.getElementById('dashboard-features');
            if (elUpload) elUpload.style.display = hasFile ? 'none' : 'flex';
            if (elFeatures) elFeatures.style.display = hasFile ? 'grid' : 'none';

            // Isolation
            const elIsoPH = document.getElementById('isolation-placeholder');
            const elIsoRes = document.getElementById('result-isolation');
            if (elIsoPH) elIsoPH.style.display = (hasFile && !session.stems) ? 'flex' : 'none';
            if (elIsoRes) elIsoRes.style.display = session.stems ? 'block' : 'none';

            // Advanced Analysis
            const elVoicePH = document.getElementById('voice-placeholder');
            const elVoiceCont = document.getElementById('voice-analysis-container');
            if (elVoicePH) elVoicePH.style.display = hasFile ? 'none' : 'flex';
            if (elVoiceCont) elVoiceCont.style.display = hasFile ? 'block' : 'none';

            // Studio
            const elStudioModeSec = document.getElementById('studio-mode-selector');
            if (elStudioModeSec) elStudioModeSec.style.display = hasFile ? 'flex' : 'none';

            const mode = session.studioMode;
            const btnStems = document.getElementById('btn-mode-stems');
            const btnSingle = document.getElementById('btn-mode-single');
            if (btnStems) btnStems.classList.toggle('active', mode === 'stems');
            if (btnSingle) btnSingle.classList.toggle('active', mode === 'single');

            const pleader = document.getElementById('mixer-placeholder');
            const meditor = document.getElementById('effects-editor');
            const mcontainer = document.getElementById('mixer-container');

            if (pleader) pleader.style.display = 'none';
            if (meditor) meditor.style.display = 'none';
            if (mcontainer) mcontainer.style.display = 'none';

            if (mode === 'stems') {
                if (session.stems) {
                    if (mcontainer) mcontainer.style.display = 'block';
                    setupMixer(session.stems);
                } else {
                    if (pleader) {
                        pleader.style.display = 'flex';
                        const p = pleader.querySelector('p');
                        if (p) p.textContent = "Vui l√≤ng t√°ch nh·∫°c c·ª• tr∆∞·ªõc khi s·ª≠ d·ª•ng b·ªô tr·ªôn ƒëa k√™nh.";
                    }
                }
            } else {
                if (meditor) {
                    meditor.style.display = 'block';
                    const container = document.getElementById('editor-track');
                    if (container && container.children.length === 0) {
                        createTrackStrip("B·∫£n g·ªëc", container);
                    }
                }
            }
        }

        function setStudioMode(mode) {
            session.studioMode = mode;
            updateSessionUI();
        }

        const btnModeStems = document.getElementById('btn-mode-stems');
        if (btnModeStems) btnModeStems.onclick = () => setStudioMode('stems');
        const btnModeSingle = document.getElementById('btn-mode-single');
        if (btnModeSingle) btnModeSingle.onclick = () => setStudioMode('single');

        function resetSession() {
            session = { filename: "", analysis: null, stems: null };
            const fileInput = document.getElementById('file-main');
            if (fileInput) fileInput.value = '';

            const uploadArea = document.getElementById('main-upload-area');
            if (uploadArea) {
                uploadArea.innerHTML = `<i class="fa-solid fa-cloud-arrow-up"></i><h3>T·∫£i l√™n b·∫£n nh·∫°c c·ªßa b·∫°n</h3><p>H·ªó tr·ª£ MP3, WAV, FLAC</p>`;
            }

            // Clear results
            const isoResult = document.getElementById('result-isolation');
            if (isoResult) {
                const container = isoResult.querySelector('.stems-container');
                if (container) container.innerHTML = '';
            }

            const mixerTracks = document.getElementById('mixer-tracks');
            const editorTrack = document.getElementById('editor-track');
            if (mixerTracks) mixerTracks.innerHTML = '';
            if (editorTrack) editorTrack.innerHTML = '';

            updateSessionUI();
            switchView('view-dashboard');
        }

        // --- Core Actions ---

        const btnIsolation = document.getElementById('btn-run-isolation');
        if (btnIsolation) {
            btnIsolation.onclick = async () => {
                const btn = btnIsolation;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

                try {
                    const res = await fetch('/analyze/isolation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    session.stems = data.stems;
                    renderStems(data.stems);
                    updateSessionUI();
                } catch (err) {
                    alert("L·ªói t√°ch nh·∫°c: " + err.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = "T√°ch ngay";
                }
            };
        }

        function renderStems(stems) {
            const elResults = document.getElementById('result-isolation');
            if (!elResults) return;
            const container = elResults.querySelector('.stems-container');
            if (!container) return;
            container.innerHTML = '';
            Object.entries(stems).forEach(([label, url]) => {
                const row = document.createElement('div');
                row.className = 'stem-player';
                row.style = "background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;";
                row.innerHTML = `<div class="stem-name" style="min-width: 100px; font-weight: bold;">${label.toUpperCase()}</div><audio controls src="${url}" style="flex: 1;"></audio>`;
                container.appendChild(row);
            });
        }

        // --- Mixer Logic ---

        function setupMixer(stems) {
            const container = document.getElementById('mixer-tracks');
            if (!container) return;
            const existingStems = Array.from(container.querySelectorAll('.track-strip')).map(s => s.dataset.label);
            const newStems = Object.keys(stems);

            if (JSON.stringify(existingStems) === JSON.stringify(newStems)) return;

            container.innerHTML = '';
            newStems.forEach(label => {
                createTrackStrip(label, container);
            });
        }

        function createTrackStrip(label, container) {
            const strip = document.createElement('div');
            strip.className = 'track-strip';
            strip.dataset.label = label;
            strip.innerHTML = `
                <div class="track-name" style="font-weight: bold; margin-bottom: 1rem; color: #4CAF50;">${label.toUpperCase()}</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem;">
                    <div class="control-group">
                        <div class="control-label"><span>√Çm l∆∞·ª£ng</span> <span class="val">1.0</span></div>
                        <input type="range" class="control-slider vol-slider" min="0" max="1" step="0.1" value="1.0">
                    </div>
                    <div class="control-group">
                        <div class="control-label"><span>T·ªëc ƒë·ªô</span> <span class="val">1.0</span>x</div>
                        <input type="range" class="control-slider speed-slider" min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div class="control-group">
                        <div class="control-label"><span>Cao ƒë·ªô</span> <span class="val">0</span> st</div>
                        <input type="range" class="control-slider pitch-slider" min="-12" max="12" step="1" value="0">
                    </div>
                </div>
            `;

            strip.querySelectorAll('input').forEach(input => {
                input.oninput = (e) => {
                    let val = parseFloat(e.target.value).toFixed(1);
                    // Find the .val span in the previous control-label div
                    const controlGroup = e.target.closest('.control-group');
                    if (controlGroup) {
                        const valEl = controlGroup.querySelector('.val');
                        if (valEl) valEl.textContent = val;
                    }
                };
            });

            container.appendChild(strip);
        }

        function getTrackData(strip, url) {
            return {
                url: url,
                volume: parseFloat(strip.querySelector('.vol-slider')?.value || 1.0),
                speed: parseFloat(strip.querySelector('.speed-slider')?.value || 1.0),
                pitch: parseFloat(strip.querySelector('.pitch-slider')?.value || 0),
                distortion: 0, echo: 0, lpf: 20000, hpf: 20, reverb: 0, pan: 0
            };
        }

        const btnRenderMix = document.getElementById('btn-render-mix');
        if (btnRenderMix) {
            btnRenderMix.onclick = async () => {
                const btn = btnRenderMix;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang k·∫øt xu·∫•t...';

                const tracks = [];
                document.querySelectorAll('#mixer-tracks .track-strip').forEach(strip => {
                    const label = strip.dataset.label;
                    tracks.push(getTrackData(strip, session.stems[label]));
                });

                try {
                    const res = await fetch('/process/mix', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tracks })
                    });
                    const data = await res.json();
                    const preview = document.getElementById('master-preview');
                    if (preview) {
                        preview.src = data.mix_url;
                        const resDiv = document.getElementById('render-result');
                        if (resDiv) resDiv.style.display = 'block';
                        preview.play();
                    }
                } catch (err) { alert(err.message); }
                finally {
                    btn.disabled = false;
                    btn.textContent = "Xu·∫•t b·∫£n Mix th√†nh ph·∫©m";
                }
            };
        }

        const btnProcessSingle = document.getElementById('btn-process-single');
        if (btnProcessSingle) {
            btnProcessSingle.onclick = async () => {
                const btn = btnProcessSingle;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

                const stripCont = document.getElementById('editor-track');
                const strip = stripCont ? stripCont.querySelector('.track-strip') : null;
                if (!strip) return;

                const track = getTrackData(strip, "/uploads/" + session.filename);

                try {
                    const res = await fetch('/process/mix', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tracks: [track] })
                    });
                    const data = await res.json();
                    const preview = document.getElementById('single-preview');
                    if (preview) {
                        preview.src = data.mix_url;
                        const resDiv = document.getElementById('single-result');
                        if (resDiv) resDiv.style.display = 'block';
                        preview.play();
                    }
                } catch (err) { alert(err.message); }
                finally {
                    btn.disabled = false;
                    btn.textContent = "√Åp d·ª•ng & Xu·∫•t t·ªáp";
                }
            };
        }

        // --- Analysis Actions ---

        const btnLPC = document.getElementById('btn-lpc-analysis');
        if (btnLPC) {
            btnLPC.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

                try {
                    const res = await fetch('/analyze/lpc', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    const container = document.getElementById('lpc-results');
                    if (container) {
                        const content = container.querySelector('.lpc-content');
                        if (content) {
                            content.innerHTML = `
                                <div style="background: rgba(76, 175, 80, 0.1); padding:1rem; border-radius:8px; margin-bottom:1.5rem;">
                                    <h4 style="margin:0; color:#4CAF50;">‚úÖ Ph√¢n t√≠ch LPC ho√†n t·∫•t</h4>
                                    <p style="margin:0.5rem 0 0 0; color:#999; font-size:0.9rem;">
                                        T·∫ßn s·ªë l·∫•y m·∫´u: ${data.lpc_data.sample_rate}Hz | B·∫≠c: ${data.lpc_data.order}
                                    </p>
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
                                    <div>
                                        <h4>H·ªá s·ªë LPC (10 ƒë·∫ßu)</h4>
                                        <div style="background:#1a1a1a; padding:1rem; border-radius:8px; overflow-x:auto;">
                                            <code style="color:#4CAF50; font-size:0.85rem;">
                                                ${data.lpc_data.lpc_coefficients.slice(0, 10).map((c, i) => `a[${i}] = ${c.toFixed(4)}`).join('<br>')}<br>...
                                            </code>
                                        </div>
                                    </div>
                                    <div>
                                        <h4>ƒê·ªì th·ªã T·ª± t∆∞∆°ng quan</h4>
                                        <img src="${data.autocorrelation_plot}" style="width:100%; border-radius:8px; border:1px solid #333;">
                                    </div>
                                </div>
                            `;
                        }
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('L·ªói LPC: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-chart-line"></i> Ph√¢n t√≠ch LPC';
                }
            };
        }

        const btnWaveform = document.getElementById('btn-waveform-analysis');
        if (btnWaveform) {
            btnWaveform.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

                try {
                    const res = await fetch('/analyze/waveform', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    const container = document.getElementById('waveform-results');
                    const canvas = document.getElementById('waveform-canvas');
                    if (canvas && container) {
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#0a0a0a';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.strokeStyle = '#FF9800';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        const pts = data.waveform.points;
                        const sx = canvas.width / 600;
                        const sy = canvas.height / 300;
                        pts.forEach((p, i) => {
                            const vx = p.x * sx;
                            const vy = canvas.height / 2 - p.y * sy;
                            if (i === 0) ctx.moveTo(vx, vy);
                            else ctx.lineTo(vx, vy);
                        });
                        ctx.stroke();
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('L·ªói Waveform: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-water"></i> D·∫°ng s√≥ng';
                }
            };
        }

        const btnHarmonics = document.getElementById('btn-formant-analysis');
        if (btnHarmonics) {
            btnHarmonics.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                try {
                    const res = await fetch('/analyze/formants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    const container = document.getElementById('formant-results');
                    if (container) {
                        const content = container.querySelector('.formant-content');
                        if (content) {
                            content.innerHTML = `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:1rem;">
                                ${data.formants.map((f, i) => `<div class="stat-card">B·ªìi √¢m ${i + 1}<br><b>${f.frequency.toFixed(0)} Hz</b></div>`).join('')}
                            </div>`;
                        }
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('L·ªói B·ªìi √¢m: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-mountain"></i> B·ªìi √¢m';
                }
            };
        }

        const btnPitch = document.getElementById('btn-pitch-analysis');
        if (btnPitch) {
            btnPitch.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                try {
                    const res = await fetch('/analyze/pitch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    const container = document.getElementById('pitch-results');
                    if (container) {
                        const canvas = document.getElementById('pitch-canvas');
                        if (canvas && data.pitch_data.length > 0) {
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#0a0a0a';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.strokeStyle = '#4CAF50';
                            ctx.beginPath();
                            const freqs = data.pitch_data.map(p => p.frequency);
                            const minF = Math.min(...freqs);
                            const maxF = Math.max(...freqs);
                            const range = (maxF - minF) || 1;
                            data.pitch_data.forEach((p, i) => {
                                const px = (i / data.pitch_data.length) * canvas.width;
                                const py = canvas.height - ((p.frequency - minF) / range) * (canvas.height - 40) - 20;
                                if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                            });
                            ctx.stroke();
                        }
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('L·ªói Pitch: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-music"></i> Theo d√µi cao ƒë·ªô';
                }
            };
        }

        const btnSpec = document.getElementById('btn-detailed-spec');
        if (btnSpec) {
            btnSpec.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                try {
                    const res = await fetch('/analyze/detailed_spectrogram', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    const container = document.getElementById('detailed-spec-results');
                    if (container) {
                        const content = container.querySelector('.spec-content');
                        if (content) content.innerHTML = `<img src="${data.spectrogram_url}" style="width:100%; border-radius:8px;">`;
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('L·ªói Ph·ªï: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-image"></i> Ph·ªï chi ti·∫øt';
                }
            };
        }

        const btnZCR = document.getElementById('btn-zcr-analysis');
        if (btnZCR) {
            btnZCR.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                try {
                    const res = await fetch('/analyze/zcr', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    const container = document.getElementById('zcr-results');
                    if (container && data.zcr_data) {
                        const zcr = data.zcr_data;
                        
                        // Update statistics
                        document.getElementById('zcr-mean').textContent = zcr.mean_zcr.toFixed(4);
                        document.getElementById('zcr-std').textContent = zcr.std_zcr.toFixed(4);
                        document.getElementById('zcr-max').textContent = zcr.max_zcr.toFixed(4);
                        document.getElementById('zcr-min').textContent = zcr.min_zcr.toFixed(4);
                        document.getElementById('zcr-description').textContent = zcr.description;
                        
                        // Update plot image
                        const plotImg = document.getElementById('zcr-plot');
                        plotImg.src = zcr.zcr_plot;
                        
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('L·ªói ZCR: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-wave-square"></i> T·∫ßn s·ªë c·∫Øt 0';
                }
            };
        }

        const btnVAD = document.getElementById('btn-vad-analysis');
        if (btnVAD) {
            btnVAD.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                try {
                    const res = await fetch('/analyze/vad', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: session.filename })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    const container = document.getElementById('vad-results');
                    if (container && data.vad_data) {
                        const vad = data.vad_data;
                        
                        // Update statistics
                        document.getElementById('vad-total-duration').textContent = vad.total_duration.toFixed(2) + 's';
                        document.getElementById('vad-voice-time').textContent = vad.total_voice_time.toFixed(2) + 's';
                        document.getElementById('vad-voice-ratio').textContent = vad.voice_ratio.toFixed(1) + '%';
                        document.getElementById('vad-num-segments').textContent = vad.num_voice_segments;
                        
                        // Display voice segments
                        const segmentsList = document.getElementById('vad-segments-list');
                        if (vad.segments.length > 0) {
                            segmentsList.innerHTML = vad.segments.map(seg => `
                                <div style="padding:0.5rem; margin:0.3rem 0; background:rgba(76,175,80,0.1); border-radius:4px; font-size:0.85rem;">
                                    <strong>[${seg.start.toFixed(2)}s - ${seg.end.toFixed(2)}s]</strong> 
                                    Duration: ${seg.duration.toFixed(2)}s
                                </div>
                            `).join('');
                        } else {
                            segmentsList.innerHTML = '<p style="color:#999;">Kh√¥ng ph√°t hi·ªán voice segments</p>';
                        }
                        
                        // Update plot image
                        const plotImg = document.getElementById('vad-plot');
                        plotImg.src = vad.vad_plot;
                        
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('L·ªói VAD: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-microphone"></i> Ph√°t hi·ªán √¢m thanh';
                }
            };
        }

        const btnLPCSynth = document.getElementById('btn-lpc-synthesis');
        if (btnLPCSynth) {
            btnLPCSynth.onclick = async function () {
                const btn = this;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
                try {
                    // C√≥ th·ªÉ th√™m dialog ƒë·ªÉ ch·ªçn parameters (pitch, excitation type, gain)
                    // T·∫°m th·ªùi d√πng default
                    const res = await fetch('/process/synthesize-lpc', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: session.filename,
                            pitch_frequency: null,  // Auto-detect
                            gain: 1.0,
                            excitation_type: 'voiced'
                        })
                    });
                    const data = await res.json();
                    if (data.error) throw new Error(data.error);

                    const container = document.getElementById('lpc-synth-results');
                    if (container && data.parameters) {
                        const params = data.parameters;
                        const stats = data.statistics;
                        
                        // Update parameters
                        document.getElementById('synth-pitch').textContent = params.pitch_frequency.toFixed(1) + ' Hz';
                        document.getElementById('synth-lpc-order').textContent = params.lpc_order;
                        document.getElementById('synth-excitation').textContent = params.excitation_type;
                        document.getElementById('synth-similarity').textContent = (stats.similarity * 100).toFixed(1) + '%';
                        document.getElementById('synth-description').textContent = data.description;
                        
                        // Set audio source
                        const audioEl = document.getElementById('synth-audio');
                        audioEl.src = data.synthesized_audio_url;
                        
                        // Set plot image
                        const plotImg = document.getElementById('synth-plot');
                        plotImg.src = data.plot_url;
                        
                        container.style.display = 'block';
                        container.scrollIntoView({ behavior: 'smooth' });
                    }
                } catch (err) { alert('L·ªói Synthesis: ' + err.message); }
                finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> T·ªïng h·ª£p t·ª´ LPC';
                }
            };
        }

    </script>
</body>

</html>